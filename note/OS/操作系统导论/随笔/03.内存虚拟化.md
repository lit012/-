## å†…å­˜è™šæ‹ŸåŒ–

### å‰è¨€

åœ¨CPUå®žçŽ°è™šæ‹ŸåŒ–çš„åŒæ—¶ï¼Œæˆ‘ä»¬è¦æƒ³åˆ°ï¼Œå½“CPUåœ¨ä¸åŒè¿›ç¨‹ä¹‹é—´åˆ‡æ¢æ—¶ï¼Œå±žäºŽè¿™äº›è¿›ç¨‹çš„å­˜å‚¨ç©ºé—´æ˜¯æ€Žæ ·å˜åŒ–çš„ã€‚åœ¨å¤šé“ç¨‹åºå¤„ç†çš„ç³»ç»Ÿä¸­ï¼ŒCPUé™¤äº†åˆ‡æ¢è¿›ç¨‹çš„æ‰§è¡Œå¤–ï¼ŒåŒæ—¶è¦æ‰¾åˆ°è¿™äº›æ–°å¼€å§‹æ‰§è¡Œçš„è¿›ç¨‹æ‰€åœ¨çš„å­˜å‚¨ç©ºé—´ã€‚

æˆ‘ä»¬å¯ä»¥æŠŠå…¶å®ƒè¿›ç¨‹çš„å†…å®¹æ”¾åœ¨ç£ç›˜ä¸Šï¼ŒæŠŠæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹çš„å†…å®¹æ”¾åœ¨å†…å­˜ä¸Šã€‚ä¸è¿‡åœ¨è¿è¡Œæ—¶å°±ä¼šå‘çŽ°ï¼Œè¿™ç§æ–¹å¼å¤ªæ…¢äº†ï¼Œå†…å­˜åˆ°ç£ç›˜çš„å†…å®¹è¿ç§»ä¼šå ç”¨å¤§é‡çš„CPUèµ„æºï¼ŒäºŽæ˜¯æˆ‘ä»¬è‡ªç„¶æƒ³åˆ°å¯ä»¥æŠŠè¦å¹¶å‘æ‰§è¡Œçš„è¿›ç¨‹å†…å®¹éƒ½æ”¾åœ¨å†…å­˜ä¸­ã€‚

![å…±äº«å†…å­˜](img3/å…±äº«å†…å­˜.png)

ä½†è¿™åŒæ—¶åˆå¸¦æ¥æ–°çš„é—®é¢˜ã€‚å¦‚æžœç¨‹åºå‘˜å¯ä»¥ç›´æŽ¥æŒ‡å®šä¸åŒè¿›ç¨‹çš„å†…å®¹åº”è¯¥æ”¾åœ¨ä»€ä¹ˆåœ°æ–¹ï¼Œé‚£å¦‚ä½•è¿›è¡Œç®¡ç†å°±æˆäº†ä¸€ä»¶éº»çƒ¦äº‹ã€‚å› ä¸ºè¿›ç¨‹ä½¿ç”¨çš„ç©ºé—´æ˜¯å¯èƒ½å¢žé•¿çš„ï¼Œä¸ºè¿›ç¨‹åˆ†é…æ–°ç©ºé—´ï¼Œå¹¶ä¸”è¦ä¿è¯æ–°ç©ºé—´ä¸èƒ½å ç”¨åˆ«çš„è¿›ç¨‹çš„ç©ºé—´ï¼ŒåŒæ—¶è¿˜å¾—ä¿è¯åœ¨ä½¿ç”¨æ—¶èƒ½é¡ºåˆ©æ‰¾åˆ°æ–°çš„ç©ºé—´ï¼Œè¿™äº›éƒ½ä¼šå ç”¨ç¨‹åºå‘˜å¤§é‡çš„ç²¾åŠ›ï¼Œå¹¶ä¸”å¯èƒ½å¯¼è‡´å†…å­˜ç®¡ç†çš„æ··ä¹±ã€‚äºŽæ˜¯ï¼Œå†…å­˜è™šæ‹ŸåŒ–å‡ºçŽ°äº†ã€‚

### è™šæ‹ŸåŒ–å†…å­˜çš„å®žè´¨

æˆ‘ä»¬ä¸å¸Œæœ›èŠ±å¤§é‡çš„æ—¶é—´ç”¨åœ¨ç®¡ç†å†…å­˜ä¸Šã€‚å¦‚æžœåœ¨å¯¹æ¯ä¸ªè¿›ç¨‹åˆ†é…å†…å­˜æ—¶ï¼Œæˆ‘ä»¬æƒ³ç›´æŽ¥å¡«ä¸€ä¸ªåœ°å€æ¯”å¦‚0x001è¿™æ ·çš„åœ°å€ï¼Œè€Œä¸æ˜¯å…ˆåœ¨å†…å­˜ä¸­æ‰¾åˆ°ä¸€å—è¶³å¤Ÿå¤§çš„ç©ºé—´ï¼Œç„¶åŽè€ƒè™‘è¿™ä¸ªç©ºé—´å¤Ÿä¸å¤Ÿç”¨ï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆå½±å“ï¼Œå†æŠŠè¿™å—ç©ºé—´çš„åœ°å€åˆ†é…å‡ºåŽ»ã€‚

åŒæ ·çš„ï¼Œåœ¨ä¸ºè¿›ç¨‹åˆ†é…å †ç©ºé—´å’Œæ ˆç©ºé—´æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›è°ƒç”¨mallocå‡½æ•°æ—¶ç›´æŽ¥å¡«æƒ³è¦çš„ç©ºé—´å¤§å°ï¼Œè€Œä¸æ˜¯æŠŠå †è¦ç”¨å“ªå—ç©ºé—´çš„åœ°å€å¡«è¿›åŽ»ã€‚

> å½“ç¨‹åºåœ¨è¿è¡Œçš„æ—¶å€™ï¼Œåˆ©ç”¨æ ˆï¼ˆstackï¼‰æ¥ä¿å­˜å½“å‰çš„å‡½æ•°è°ƒç”¨ä¿¡æ¯ï¼Œåˆ†é…ç©ºé—´ç»™å±€éƒ¨å˜é‡ï¼Œä¼ é€’å‚æ•°å’Œå‡½æ•°è¿”å›žå€¼ã€‚æœ€åŽï¼Œå †ï¼ˆheapï¼‰ç”¨äºŽç®¡ç†åŠ¨æ€åˆ†é…çš„ã€ç”¨æˆ·ç®¡ç†çš„å†…å­˜ã€‚
>
> ![åœ°å€ç©ºé—´](img3/åœ°å€ç©ºé—´.png)

å¦å¤–ï¼Œæˆ‘ä»¬è¿˜å¸Œæœ›è¿›ç¨‹åœ¨è¿è¡Œæ—¶ä¸è¦è®¿é—®å…¶å®ƒè¿›ç¨‹çš„ç©ºé—´ï¼Œä¿è¯å„ä¸ªè¿›ç¨‹çš„å®‰å…¨ã€‚

ä¸ºäº†å®žçŽ°è¿™ä¸€ç›®çš„ï¼Œæˆ‘ä»¬æå‡ºå†…å­˜è™šæ‹ŸåŒ–ã€‚å†…å­˜è™šæ‹ŸåŒ–çš„å®žçŽ°è®©è¿›ç¨‹æœ‰äº†ä¸€å—ä¸“é—¨çš„å†…å­˜ï¼Œè¿™å—å†…å­˜çš„æ‰€æœ‰ç©ºé—´åªå±žäºŽè¿™ä¸ªè¿›ç¨‹è‡ªå·±ï¼Œè¿›ç¨‹å¯ä»¥ä»»æ„åœ°ä½¿ç”¨è¿™å—å†…å­˜çš„æ‰€æœ‰ç©ºé—´ï¼Œä¸éœ€è¦è€ƒè™‘å…¶å®ƒè¿›ç¨‹ã€‚æ¯ä¸ªè¿›ç¨‹éƒ½æ˜¯è¿™æ ·çš„ï¼Œå¤§å®¶éƒ½æœ‰è‡ªå·±çš„å†…å­˜ï¼Œéƒ½å¯ä»¥éšæ„ä½¿ç”¨å†…å­˜çš„ç©ºé—´è€Œæ— éœ€æ‹…å¿ƒæ‰“æ‰°åˆ°å…¶å®ƒè¿›ç¨‹ã€‚

å¬èµ·æ¥ä¼¼ä¹Žå¾ˆç¾Žå¥½ï¼Œå°±åƒå‡çš„ä¸€æ ·ï¼Œäº‹å®žä¸Šï¼Œè¿™å°±æ˜¯å‡çš„ã€‚ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿä½¿ç”¨äº†ä¸€ç§æ–¹æ³•ï¼Œè®©è¿›ç¨‹ä½¿ç”¨ä¸€ä¸ªå¥½åƒåªå¯¹è‡ªå·±å¼€æ”¾çš„å†…å­˜çš„åœ°å€ï¼Œå®žé™…ä¸Šè¿™ä¸ªåœ°å€ä¼šè¢«è‡ªåŠ¨è½¬æ¢æˆä¸ºçœŸå®žå†…å­˜ä¸­ä¸€ä¸ªç©ºé—´çš„ç‰©ç†åœ°å€ã€‚

æˆ‘ä»¬æŠŠè¿›ç¨‹è‡ªä»¥ä¸ºè‡ªå·±ä½¿ç”¨çš„åœ°å€å«åšè™šæ‹Ÿåœ°å€ï¼ŒæŠŠè¿›ç¨‹å®žé™…ä½¿ç”¨çš„åœ°å€å«åšç‰©ç†åœ°å€ã€‚è¿›ç¨‹å¯ä»¥éšæ„åœ°ä½¿ç”¨è™šæ‹Ÿåœ°å€ï¼Œæ“ä½œç³»ç»Ÿå’Œç¡¬ä»¶ä¼šæŠŠè¿™äº›è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºç‰©ç†åœ°å€ï¼Œå¹¶ä¸”ä¿è¯ä¸åŒè¿›ç¨‹æ‰€ç”¨çš„ç©ºé—´ä¸ä¼šç›¸äº’å¹²æ‰°ã€‚

å°½ç®¡è¿›ç¨‹æ‰€ç”¨çš„è™šæ‹Ÿåœ°å€çš„åœ°å€ç©ºé—´å¾ˆå¤§ï¼Œè®©æˆ‘ä»¬ä¸å…æ‹…å¿§å¦‚æžœæ‰€æœ‰çš„è¿›ç¨‹éƒ½æŠŠåœ°å€ç©ºé—´å®Œå…¨å æ»¡ï¼Œé‚£å²‚ä¸æ˜¯ä¼šå¯¼è‡´å†…å­˜æº¢å‡ºã€‚ä¸è¿‡è¿™ä»½æ‹…å¿ƒæ˜¯å¤šä½™çš„ï¼Œå¤§å¤šæ˜¯è¿›ç¨‹å¹¶ä¸ä¼šå®Œå…¨å ç”¨åœ°å€ç©ºé—´ï¼Œé™¤äº†ä¿ç•™åŸºæœ¬çš„ç©ºé—´å­˜æ”¾ç¨‹åºå’Œå¿…è¦çš„å‚æ•°å¤–ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹éƒ½æ˜¯éœ€è¦æ—¶ç”³è¯·ä¸€å—ç©ºé—´ï¼Œä¸éœ€è¦æ—¶é‡Šæ”¾ç©ºé—´ï¼Œè¿™äº›æ“ä½œä½¿å¾—è¿›ç¨‹è™½ç„¶ä¸ä¼šç›´æŽ¥å ç”¨æ‰€æœ‰ç©ºé—´ï¼Œä½†ä¼šå¸Œæœ›æœ‰é¢„æœŸçš„ç©ºé—´ä¸ºå…¶ä¿ç•™ã€‚è™šæ‹Ÿåœ°å€çš„ä½œç”¨å°±æ˜¯ä¸ºè¿›ç¨‹æä¾›è¶³å¤Ÿçš„é¢„æœŸç©ºé—´ï¼Œåœ¨ç”¨åˆ°è¿™äº›é¢„æœŸç©ºé—´æ—¶ï¼Œæ“ä½œç³»ç»Ÿå’Œç¡¬ä»¶ä¼šè¿›è¡Œåœ°å€è½¬æ¢æä¾›ç»™å®žé™…çš„å†…å­˜ç©ºé—´ï¼Œè€Œè¿™äº›å†…å­˜ç©ºé—´åˆå¯èƒ½æ˜¯å…¶å®ƒè¿›ç¨‹åˆšåˆšé‡Šæ”¾æˆ–è€…è¿˜æœªä½¿ç”¨çš„é¢„æœŸç©ºé—´ã€‚

---

è¿™æ ·çœ‹æ¥ï¼Œè™šæ‹ŸåŒ–å†…å­˜è‡³å°‘æœ‰ä¸‰ä¸ªå¥½å¤„ï¼š

1. ç¨‹åºå‘˜ä¸éœ€è¦è‡ªå·±åŽ»æ‰¾ç©ºé—´åˆ†é…å†…å­˜ï¼Œæ‰€æœ‰çš„è¿›ç¨‹éƒ½å¯ä»¥ç›´æŽ¥ä»Ž0x0000å¼€å§‹ä½¿ç”¨å†…å­˜ï¼Œæ¯•ç«Ÿå¯¹å®ƒä»¬æ¥è¯´è‡ªå·±æ˜¯ç‹¬å å†…å­˜çš„ã€‚

2. æ‰€æœ‰çš„è¿›ç¨‹åœ¨è¿è¡Œæ—¶éƒ½ç›´æŽ¥ä½¿ç”¨å†…å­˜ä½œä¸ºå­˜å‚¨ç©ºé—´ï¼Œé€Ÿåº¦å¾ˆå¿«ã€‚æ¯•ç«Ÿå¦‚æžœçœŸçš„è®©è¿›ç¨‹ç‹¬å å†…å­˜ï¼Œé‚£å°±è¦å¤šä¸€æ­¥ä»Žç£ç›˜é€æ•°æ®åˆ°å†…å­˜äº†ã€‚

3. å­˜å‚¨ç©ºé—´çš„å®žé™…åˆ†é…äº¤ç»™æ“ä½œç³»ç»Ÿå’Œç¡¬ä»¶ï¼Œå°±ä¸éœ€è¦æ‹…å¿ƒä½ æŸä¸€å¤©ä¸å°å¿ƒæŠŠä¸€ä¸ªè¿›ç¨‹çš„æ•°æ®æ”¾åœ¨å¦ä¸€ä¸ªè¿›ç¨‹çš„ç©ºé—´ä¸Šäº†ã€‚

---

è™šæ‹ŸåŒ–å†…å­˜ä¿è¯äº†æ‰€æœ‰è¿›ç¨‹éƒ½èƒ½å®žçŽ°å¤§å®¹é‡å­˜å‚¨ã€é«˜é€Ÿè¿è¡Œã€å®‰å…¨ä¾¿æ·ï¼Œå½“ç„¶å‰ææ˜¯è¿™äº›å†…å­˜ä¸ä¼šç›´æŽ¥å æ»¡è‡ªå·±çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ã€‚


### åœ°å€è½¬æ¢æœºåˆ¶

åœ°å€è½¬æ¢ç›´æŽ¥æ¥è¯´å°±æ˜¯åœ¨è¿›ç¨‹è¦è®¿é—®è™šæ‹Ÿå†…å­˜æ—¶ï¼Œç”±ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿæ ¹æ®è™šæ‹Ÿåœ°å€æä¾›è¿›ç¨‹éœ€è¦çš„å®žé™…ç‰©ç†åœ°å€ã€‚

> ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„åœ°å€è½¬æ¢çš„ä¾‹å­ã€‚è¿›ç¨‹å°†è‡ªå·±çš„ä»£ç å’Œå…¶å®ƒå†…å®¹ç›´æŽ¥æ”¾åœ¨è™šæ‹Ÿç©ºé—´çš„å¼€å¤´ï¼Œè€Œå®žé™…ä¸Šæ“ä½œç³»ç»Ÿå’Œç¡¬ä»¶ä¼šåœ¨å®ƒè®¿é—®ç©ºé—´ä¹‹å‰å°†æŒ‡é’ˆè½¬ç§»åˆ°åˆé€‚çš„ä½ç½®ï¼Œä¸è¿‡è¿›ç¨‹è‡ªå·±ä¸çŸ¥é“å®ƒå·²ç»è¢«å¯¼å‘å¦ä¸€ä¸ªåœ°å€äº†ã€‚
>
> ![åœ°å€è½¬æ¢](img3/åœ°å€è½¬æ¢.png)

#### åŠ¨æ€é‡å®šä½

åŠ¨æ€é‡å®šä½æ˜¯åŸºäºŽåŸºå€/ç•Œé™å¯„å­˜å™¨çš„ç¡¬ä»¶å®žçŽ°çš„åœ°å€è½¬æ¢çš„æ–¹å¼ï¼Œä¸Žä¹‹å¯¹åº”çš„è¿˜æœ‰é™æ€é‡å®šä½ã€‚

è¿™é‡Œä»‹ç»çš„åŠ¨æ€é‡å®šä½æ–¹å¼é»˜è®¤å†…å­˜ä¸ºæ¯ä¸€ä¸ªè¿›ç¨‹åˆ†é…ä¸€ä¸ªè¿žç»­çš„ç©ºé—´ã€‚

åŠ¨æ€é‡å®šä½ä¸ºCPUå‡†å¤‡äº†ä¸¤ä¸ªå¯„å­˜å™¨ï¼Œä¸€ä¸ªæ˜¯åŸºå€å¯„å­˜å™¨ï¼Œä¸€ä¸ªæ˜¯ç•Œé™å¯„å­˜å™¨ã€‚å½“è¿›ç¨‹è®¿é—®å†…å­˜æ—¶ï¼Œæ¯”å¦‚ä»Žç¨‹åºè®¡æ•°å™¨ä¸­å–æŒ‡ä»¤åœ°å€ï¼Œå¾—åˆ°çš„åœ°å€æ˜¯è™šæ‹Ÿåœ°å€ï¼Œè™šæ‹Ÿåœ°å€çš„å€¼ä¼šåŠ ä¸ŠåŸºå€å¯„å­˜å™¨ä¸­å­˜å‚¨çš„å€¼å½¢æˆæ–°çš„åœ°å€ï¼Œè¿™ä¸ªæ–°åœ°å€å°±æ˜¯è¿›ç¨‹æŒ‡ä»¤çš„ç‰©ç†åœ°å€ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒCPUä¼šæ ¹æ®ç•Œé™å¯„å­˜å™¨çš„å€¼æ£€æµ‹è¿›ç¨‹è®¿é—®çš„åœ°å€ç©ºé—´æœ‰æ²¡æœ‰è¶Šç•Œï¼Œå¦‚æžœè¿›ç¨‹çš„è™šæ‹Ÿç©ºé—´å¤§å°ä¸º16KBï¼Œè€Œè¿›ç¨‹è®¿é—®çš„è™šæ‹Ÿåœ°å€æ˜¯-1æˆ–è€…17Kï¼Œé‚£ä¹ˆé©¬ä¸Šå°±ä¼šå‘ç”Ÿä¸­æ–­ï¼Œæ“ä½œç³»ç»Ÿä¼šåœæ­¢è¯¥éžæ³•è¿›ç¨‹ï¼ˆæœ‰çš„ç•Œé™å¯„å­˜å™¨ä¹Ÿå¯èƒ½æ˜¯åœ¨å¾—åˆ°ç‰©ç†åœ°å€ä¹‹åŽæ£€æŸ¥ç‰©ç†åœ°å€çš„ï¼‰ã€‚

æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ç‹¬å±žäºŽè‡ªå·±çš„åŸºå€/ç•Œé™å¯„å­˜å™¨ï¼Œå½“è¿›ç¨‹åˆ‡æ¢æ—¶å¯„å­˜å™¨çš„å€¼ä¼šä¿ç•™åœ¨è¿›ç¨‹ç»“æž„æˆ–è€…è¿›ç¨‹æŽ§åˆ¶å—ä¸­ï¼Œæ–°è¿›ç¨‹çš„åŸºå€/ç•Œé™å¯„å­˜å™¨çš„å€¼ä¼šå†™å…¥å¯„å­˜å™¨ï¼Œä»¥æ­¤æ¥ç¡®ä¿æ¯ä¸ªè¿›ç¨‹æ‰€ä½¿ç”¨çš„ç©ºé—´æ˜¯ç›¸äº’éš”ç¦»çš„ã€‚

![åŠ¨æ€é‡å®šä½](img3/åŠ¨æ€é‡å®šä½ç¤ºä¾‹.png)

![åŠ¨æ€é‡å®šä½çš„ç¡¬ä»¶æ”¯æŒ](img3/åŠ¨æ€é‡å®šä½çš„ç¡¬ä»¶æ”¯æŒ.png)

---

![å¤šè¿›ç¨‹åŠ¨æ€é‡å®šä½](img3/å¤šè¿›ç¨‹åŠ¨æ€é‡å®šä½1.png)
![å¤šè¿›ç¨‹åŠ¨æ€é‡å®šä½](img3/å¤šè¿›ç¨‹åŠ¨æ€é‡å®šä½2.png)

---

æ‰€è°“åŠ¨æ€é‡å®šä½çš„æ„æ€å°±æ˜¯åœ¨è¿›ç¨‹è¿è¡Œçš„è¿‡ç¨‹ä¸­åœ°å€é‡å®šä½ï¼Œæ¯æ¬¡è®¿é—®å†…å­˜æ—¶éƒ½é‡å®šä½ï¼Œä¸å½±å“è¿›ç¨‹æœ¬èº«çš„è¿è¡Œã€‚ä¸Žä¹‹ç›¸å¯¹çš„é™æ€é‡å®šä½åˆ™æ˜¯å°†åœ°å€çš„è½¬æ¢ç¨‹åºåŠ å…¥åˆ°è¿›ç¨‹ä»£ç ä¸­ï¼Œä¹Ÿå°±æ˜¯å½“è¿›ç¨‹è¿è¡Œåˆ°è®¿é—®å†…å­˜æ—¶éœ€è¦ä¸“é—¨è¿è¡Œåœ°å€è½¬æ¢çš„ä»£ç ï¼Œè¿™ç§æ–¹å¼éœ€è¦ç¨‹åºå‘˜è‡ªå·±åˆ¤æ–­å¦‚ä½•åˆ†é…å†…å­˜ã€‚æ˜¾ç„¶ï¼Œè¿™ç§æ–¹å¼å’Œç”±ç¨‹åºå‘˜ç›´æŽ¥åˆ†é…å†…å­˜ç©ºé—´ä¸€æ ·ï¼Œä½Žæ•ˆä¸”ä¸å®‰å…¨ã€‚


è¿™ä¸ªæ–¹æ³•è™½ç„¶ç®€å•å®žçŽ°äº†å†…å­˜è™šæ‹ŸåŒ–ï¼Œä½†å¯¹å†…å­˜èµ„æºçš„åˆ©ç”¨çŽ‡è¿˜ä¸å¤Ÿé«˜ã€‚å¾ˆæ˜Žæ˜¾å¯ä»¥çœ‹å‡ºï¼Œåœ¨åˆ†é…çš„ç‰©ç†ç©ºé—´ä¸­æœ‰å¤§é‡çš„ç©ºé—´ä½œä¸ºè¿›ç¨‹æœªæ¥å¯èƒ½ä½¿ç”¨ä½†çŽ°åœ¨å¹¶æ²¡æœ‰ç”¨ä¸Šçš„ç©ºé—´ï¼Œè¿™éƒ¨åˆ†ç©ºé—´è¢«è¿›ç¨‹ç‹¬å ï¼Œé€ æˆäº†å†…å­˜çš„æµªè´¹ã€‚è¿™ç§æµªè´¹æˆ‘ä»¬ä¸€èˆ¬ç§°ä¹‹ä¸ºå†…éƒ¨ç¢Žç‰‡ã€‚

#### åˆ†æ®µ

æˆ‘ä»¬å·²ç»çŸ¥é“å¯¹äºŽä¸€ä¸ªè¿›ç¨‹æ¥è¯´ï¼Œå®Œæ•´çš„ä¸€å—åœ°å€ç©ºé—´åº”è¯¥åŒ…å«ä»£ç ã€å †ã€æ ˆä»¥åŠå †å’Œæ ˆä¹‹é—´é¢„ç•™å‡ºæ¥çš„ç©ºé—´ã€‚é¢„ç•™ç©ºé—´çš„å­˜åœ¨å¯¼è‡´å†…å­˜çš„èµ„æºæµªè´¹ï¼Œä¸ºäº†æé«˜åˆ©ç”¨çŽ‡ï¼Œæˆ‘ä»¬ä¸å†ä¸€æ¬¡ä¸ºä¸€æ•´ä¸ªè¿›ç¨‹åˆ†é…ç©ºé—´ï¼Œè€Œæ˜¯ä¸ºæ®µåˆ†é…ç©ºé—´ã€‚

ä¸€ä¸ªæ®µæ˜¯ä¸€å—è¿žç»­çš„å†…å®¹ï¼Œæ¯”å¦‚è¿›ç¨‹çš„æ‰€æœ‰ä»£ç ã€è¿›ç¨‹çš„å †æˆ–æ ˆï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºä»£ç æ®µã€å †æ®µã€æ ˆæ®µã€‚

åŸºäºŽæ®µåˆ†é…å†…å­˜çš„éœ€è¦ï¼Œä¸€å¯¹åŸºå€/ç•Œé™å¯„å­˜å™¨ä¹Ÿè¢«æ‰©å±•ä¸ºä¸‰å¯¹ï¼Œå¹¶ä¸“å±žäºŽæŸä¸ªæ®µã€‚CPUï¼Œæ›´å‡†ç¡®æ¥è¯´æ˜¯CPUä¸­ç®¡ç†å†…å­˜çš„MMUï¼Œæ ¹æ®æ¯å¯¹æ®µå¯„å­˜å™¨çš„å†…å®¹å’Œè™šæ‹Ÿåœ°å€æ¥å†³å®šæ®µçš„ç‰©ç†åœ°å€ã€‚

![æ®µåˆ†é…](img3/æ®µåˆ†é….png)

æ®µå¯„å­˜å™¨é™¤äº†è¦ä¿å­˜åŸºå€å’Œç•Œé™å¤–ï¼Œè¿˜è¦æœ‰å…³äºŽè¯¥æ®µå±žäºŽå“ªä¸ªéƒ¨åˆ†çš„æ ‡è¯†ï¼Œæ®µç©ºé—´çš„å¢žé•¿æ–¹å‘ï¼Œæ®µç©ºé—´æ˜¯å¦è¢«ä¿æŠ¤ã€‚åœ¨å†…å­˜ç©ºé—´ä¸­ï¼Œå †å’Œæ ˆçš„æ®µç©ºé—´å¢žé•¿æ–¹å‘å¾€å¾€ç›¸åã€‚æœ‰çš„ä»£ç å¯èƒ½å› ä¸ºå…¶é€šç”¨æ€§ä¼šè¢«å…±äº«ï¼Œè¿™äº›ä»£ç æ®µè¦è®¾å¤‡ä¿æŠ¤ä½ä»Žè€Œå‘Šè¯‰è¿›ç¨‹è¯¥ä»£ç æ®µåªèƒ½è¯»ï¼Œä¸èƒ½å†™ã€‚

![æ®µå¯„å­˜å™¨çš„å€¼](img3/æ®µå¯„å­˜å™¨çš„å€¼.png)

å¦‚æžœè®¿é—®æ®µçš„å†…å­˜æ—¶å‡ºçŽ°äº†è¶Šç•Œï¼Œå°±ä¼šå‘ç”Ÿæ®µå¼‚å¸¸æˆ–è€…æ®µé”™è¯¯ã€‚å¾ˆå¤šå…¶å®ƒå†…å­˜è¶Šç•Œçš„æƒ…å†µä¹Ÿä¼šè¢«ç§°ä¸ºæ®µå¼‚å¸¸æˆ–æ®µé”™è¯¯ï¼ˆåŽŸå› ä¸æ˜Žï¼‰ã€‚

åˆ†æ®µæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºå¤–éƒ¨ç¢Žç‰‡ã€‚å¤–éƒ¨ç¢Žç‰‡æ˜¯æŒ‡ç”±äºŽåˆ†æ®µè€Œå¯¼è‡´å†…å­˜ä¸­çš„ç©ºé—²ç©ºé—´è¢«åˆ‡å‰²å¾—ä¸ƒé›¶å…«è½ï¼Œè¿™äº›ç©ºé—²ç©ºé—´åŠ åœ¨ä¸€èµ·æˆ–è®¸å¾ˆå¤§ï¼Œä½†ä½œä¸ºç¢Žç‰‡åˆ†æ•£åœ¨å†…å­˜ä¸­å°±å¾ˆéš¾ç”¨ä¸Šã€‚å°±å¥½åƒæ–¹ä¾¿é¢ä¸­çš„ç¢Žç‰‡ä¸€æ ·ï¼Œå°½ç®¡çœ‹èµ·æ¥å¾ˆå¤šï¼Œä½†å¦‚æžœçœŸçš„å’Œé¢é¥¼ä¸€èµ·æ³¡çš„è¯å°±å¾ˆéš¾æžå‡ºæ¥ã€‚

![å¤–ç¢Žç‰‡](img3/å¤–ç¢Žç‰‡.png)

#### ç©ºé—²ç©ºé—´ç®¡ç†

å¯¹äºŽç©ºé—²ç©ºé—´çš„åˆ†é…ç®¡ç†ä¸»è¦é’ˆå¯¹å¤–éƒ¨ç¢Žç‰‡ï¼Œè¦ä¿è¯å°½é‡å°‘äº§ç”Ÿå¤–éƒ¨ç¢Žç‰‡ï¼Œæé«˜å†…å­˜çš„åˆ©ç”¨çŽ‡ã€‚

---

é¦–å…ˆæˆ‘ä»¬äº†è§£ä¸€ä¸‹ç©ºé—´è¢«åˆ†é…å’Œé‡Šæ”¾æ—¶å‘ç”Ÿäº†ä»€ä¹ˆã€‚

è¿™æ˜¯ä¸€ä¸ª30å­—èŠ‚çš„å †ï¼Œå®ƒé€šå¸¸ç”±cè¯­è¨€çš„mallocåˆ†é…ã€‚

![å †](img3/å †.png)

å¦‚æžœè¿™ä¸ªå †æœ‰ç©ºé—²åˆ—è¡¨ï¼Œé‚£ä¹ˆç©ºé—²åˆ—è¡¨åº”è¯¥é•¿è¿™ä¸ªæ ·å­ã€‚

![ç©ºé—²åˆ—è¡¨](img3/ç©ºé—²åˆ—è¡¨.png)

å¦‚æžœæˆ‘ä»¬è¦ç”³è¯·è¶…è¿‡10å­—èŠ‚çš„ç©ºé—´ï¼Œé‚£ä¹ˆä¼šå¤±è´¥ï¼Œè¿”å›žå€¼ä¸ºNULLã€‚å¦‚æžœç”³è¯·1å­—èŠ‚ç©ºé—´å°±å¾ˆå®¹æ˜“ã€‚

![ç©ºé—²åˆ—è¡¨](img3/ç©ºé—²åˆ—è¡¨2.png)

å¦‚æžœå°†å ç”¨çš„ç©ºé—´é‡Šæ”¾ï¼Œå°±ä¼šäº§ç”Ÿä¸‹é¢çš„æ•ˆæžœã€‚

![ç©ºé—²åˆ—è¡¨](img3/ç©ºé—²åˆ—è¡¨3.png)

è™½ç„¶çœ‹èµ·æ¥æ˜¯ä¸€æ•´å—çš„ç©ºé—²ç©ºé—´ï¼Œä½†ç”±äºŽç©ºé—²åˆ—è¡¨å°†å…¶åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼Œæ‰€ä»¥è¿˜æ˜¯ä¸èƒ½ç”³è¯·è¶…è¿‡10ä¸ªå­—èŠ‚çš„ç©ºé—´ï¼Œå¿…é¡»è¿›è¡Œåˆå¹¶ã€‚

![ç©ºé—²åˆ—è¡¨](img3/ç©ºé—²åˆ—è¡¨4.png)

åˆ°è¿™ä¸€æ­¥æ‰å®Œæˆäº†ç©ºé—²ç©ºé—´çš„ç®¡ç†ã€‚

æ‰€ä»¥ä»»ä½•ç©ºé—²åˆ—è¡¨çš„ç®¡ç†éƒ½æ¶‰åŠåˆ°ç©ºé—´çš„åˆ†å‰²ä¸Žåˆå¹¶ã€‚

---

æŽ¥ä¸‹æ¥æˆ‘ä»¬äº†è§£ä¸€ä¸‹å¦‚ä½•åœ¨ç©ºé—²ç©ºé—´å†…éƒ¨æž„å»ºä¸€ä¸ªç©ºé—²åˆ—è¡¨ã€‚

ä¸ºäº†è¿½è¸ªç©ºé—²ç©ºé—´å’Œå·²åˆ†é…çš„ç©ºé—´ï¼Œæˆ‘ä»¬ä¼šåœ¨è¿™äº›ç©ºé—´å—çš„å¤´éƒ¨æ”¾ä¸Šä¸€äº›ä¿¡æ¯ï¼Œè¿™ç§æ–¹å¼åœ¨Cåˆ†é…å†…å­˜æ—¶å¾ˆå¸¸ç”¨ã€‚

![ç©ºé—´è¿½è¸ª](img3/ç©ºé—´è¿½è¸ª.png)

åœ¨ä¸Šå›¾ä¸­ï¼Œç”³è¯·20å­—èŠ‚çš„ç©ºé—´å®žé™…ä¸Šä¼šåˆ†é…æ›´å¤šç©ºé—´ï¼Œå¤šä½™çš„ç©ºé—´ä½œä¸ºå¤´å—ï¼Œé‡Œé¢å­˜æ”¾ç€è¿™ä¸€æ•´å—ç©ºé—´çš„ä¿¡æ¯ã€‚sizeæè¿°äº†è¯¥ç©ºé—´çš„å¤§å°ï¼Œmagicæ˜¯å¹»æ•°ï¼Œç”¨æ¥éªŒè¯å®Œæ•´æ€§å’Œå…¶å®ƒä¿¡æ¯ã€‚ç»™ç”¨æˆ·å®žé™…è¿”å›žçš„æŒ‡é’ˆå¹¶ä¸æ˜¯å¤´æŒ‡é’ˆhptrï¼Œè€Œæ˜¯æŒ‡å‘ç©ºé—´çš„ptrï¼Œåœ¨ä½¿ç”¨freeå‡½æ•°é‡Šæ”¾ç©ºé—´æ—¶ï¼Œfreeä¼šæ ¹æ®ptrçš„ä½ç½®æ‰¾åˆ°hptrï¼Œä»Žè€ŒçŸ¥é“è‡ªå·±è¦é‡Šæ”¾å¤šå¤§çš„ç©ºé—´ã€‚

è¿™ç§åŠ å…¥å¤´å—çš„æ–¹æ³•å¯ä»¥è®©æˆ‘ä»¬çŸ¥é“é‚£äº›åˆ†é…çš„ç©ºé—´å’Œæœªåˆ†é…çš„ç©ºé—´çš„æƒ…å†µï¼Œæ¯”å¦‚ä¸‹é¢è¿™ç§ã€‚

![ç©ºé—²åˆ—è¡¨](img3/åµŒå…¥ç©ºé—²åˆ—è¡¨.png)

ç©ºé—²å—çš„å¤´éƒ¨æ˜¯è¯¥å—å¤§å°å’ŒæŒ‡å‘ä¸‹ä¸€ä¸ªç©ºé—²å—çš„æŒ‡é’ˆï¼Œè¢«åˆ†é…çš„100å­—èŠ‚ç©ºé—´å¤´éƒ¨æ˜¯è¯¥å—å¤§å°å’ŒéªŒè¯å®Œæ•´æ€§çš„å¹»æ•°ã€‚

![ç©ºé—²åˆ—è¡¨](img3/åµŒå…¥ç©ºé—²åˆ—è¡¨2.png)

ç„¶åŽå†åˆ†é…ä¸¤å—ç©ºé—´ï¼ŒæŽ¥ç€é‡Šæ”¾å¤¹åœ¨ä¸­é—´çš„é‚£ä¸€å—ã€‚äºŽæ˜¯è¿™ä¸ªå †ç©ºé—´ä¸­å°±æœ‰äº†ä¸¤ä¸ªç©ºé—²å—ç»„æˆçš„ç©ºé—²åˆ—è¡¨ï¼Œä¸€å¤§ä¸€å°ã€‚100å­—èŠ‚çš„ç©ºé—²å†…å­˜å—çš„æŒ‡é’ˆæŒ‡å‘äº†å¤§çš„ç©ºé—²å—ï¼Œè¿™æ ·ä¸¤ä¸ªç©ºé—²å—å°±ç»„æˆäº†ä¸€ä¸ªé“¾è¡¨ï¼Œå¦‚æžœæœªæ¥è¿˜æœ‰åˆ†å‰²å‡ºæ¥çš„ç©ºé—²å—å°±åˆä¼šåŠ å…¥åˆ°è¿™ä¸ªé“¾è¡¨ä¸­ï¼Œé€šè¿‡é“¾è¡¨å°±èƒ½å¾—åˆ°æ‰€æœ‰çš„ç©ºé—²å—ã€‚

å½“æ‰€æœ‰çš„ç©ºé—´é‡Šæ”¾å®ŒåŽï¼Œå°±ä¼šå½¢æˆä¸‹é¢è¿™æ ·ç”±ç©ºé—²ç©ºé—´ç¢Žç‰‡ç»„æˆçš„é“¾è¡¨ã€‚

![ç©ºé—²åˆ—è¡¨](img3/åµŒå…¥ç©ºé—²åˆ—è¡¨3.png)

ä¸ºäº†æ­£å¸¸ä½¿ç”¨ç©ºé—²ç©ºé—´ï¼Œè¿˜éœ€è¦æœ€åŽä¸€æ­¥ï¼Œé‚£å°±æ˜¯é€šè¿‡éåŽ†æ•´ä¸ªåˆ—è¡¨åˆå¹¶ç©ºé—²å—ã€‚

è¿™å°±æ˜¯ç®¡ç†ç©ºé—²ç©ºé—´çš„åº•å±‚æœºåˆ¶ï¼ŒåŸºäºŽè¿™æ ·çš„æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥æå‡ºä¸€äº›ç­–ç•¥æ¥ä¿è¯å¯¹å†…å­˜ç©ºé—´çš„åˆ©ç”¨çŽ‡æœ€å¤§åŒ–ã€‚

---

ä¸åŒçš„å†…å­˜åˆ†é…æƒ…å†µæœ‰ä¸åŒçš„åˆ†é…ç­–ç•¥ï¼Œå¯¹äºŽåŒä¸€ç§æƒ…å†µï¼Œæœ‰äº›ç­–ç•¥çš„æ•ˆæžœå¯èƒ½æ­£å¥½ç›¸åã€‚

##### æœ€ä¼˜åŒ¹é…

éåŽ†ç©ºé—²åˆ—è¡¨ï¼Œä»Žæ‰€æœ‰å¤§äºŽç­‰äºŽå¾…ç”³è¯·ç©ºé—´çš„ç©ºé—²å—ä¸­æ‰¾åˆ°æœ€å°çš„é‚£ä¸€ä¸ªã€‚

è¿™æ ·ä¿è¯æ¯æ¬¡ç”³è¯·ç©ºé—´æ—¶å°½é‡æ‰¾åˆ°æœ€åˆé€‚çš„ï¼Œä»Žè€Œå°†æ›´å¤šç©ºé—´èŠ‚çœä¸‹æ¥ï¼Œä½†æ˜¯éåŽ†çš„å¼€é”€å¾ˆå¤§ã€‚

##### æœ€å·®åŒ¹é…

éåŽ†åˆ—è¡¨ï¼Œæ‰¾åˆ°æœ€å¤§çš„ç©ºé—²å—ã€‚

è¿™æ ·åšå¯ä»¥ç•™ä¸‹å°½å¯èƒ½å¤§çš„ç©ºé—²å—æä¾›ç»™å…¶å®ƒè¯·æ±‚ã€‚ç¼ºç‚¹æ˜¯å¼€é”€å¤§ï¼Œå¹¶ä¸”å®žè·µè¯æ˜Žè¿™ç§æ–¹å¼ä¼šäº§ç”Ÿå¾ˆå¤šç¢Žç‰‡ï¼Œä¸æ„§ä¸ºæœ€å·®ä¹‹åã€‚

##### é¦–æ¬¡åŒ¹é…

æ‰¾åˆ°ç¬¬ä¸€ä¸ªè¶³å¤Ÿå¤§çš„å—å°±è¿”å›žåœ°å€ï¼Œä¸éœ€è¦éåŽ†æ•´ä¸ªåˆ—è¡¨ã€‚

ä¼˜ç‚¹æ˜¯å¼€é”€å°ï¼Œç¼ºç‚¹æ˜¯å¾ˆå®¹æ˜“åœ¨é å‰çš„ç©ºé—²å—å……æ»¡ç¢Žç‰‡ã€‚ç”±äºŽç¢Žç‰‡é›†ä¸­åœ¨é å‰çš„ä½ç½®ï¼Œæ‰€ä»¥åœ¨é‡Šæ”¾ç©ºé—´æ—¶åˆå¹¶çš„ä¹Ÿæ˜¯é å‰ä½ç½®çš„æ›´å¤šï¼Œå› æ­¤å¯ä»¥è®©ç©ºé—²åˆ—è¡¨çš„å…ƒç´ æ ¹æ®åœ°å€æŽ’åºï¼ˆä¼ ç»Ÿæ–¹å¼æ˜¯æ ¹æ®ç©ºé—²å—äº§ç”Ÿçš„å…ˆåŽæ¬¡åºæŽ’åºï¼Œæ¯•ç«Ÿæ˜¯é“¾è¡¨ï¼‰ï¼Œè¿™æ ·å°±èƒ½ä¿è¯ç©ºé—´é‡Šæ”¾åŽé©¬ä¸Šå°±èƒ½è¯†åˆ«å‡ºæ˜¯å¦éœ€è¦åˆå¹¶ã€‚

##### ä¸‹æ¬¡åŒ¹é…

è¿™ç§æ–¹å¼å¤šç»´æŠ¤ä¸€ä¸ªæŒ‡é’ˆï¼Œåˆšå¼€å§‹æŒ‡é’ˆæŒ‡å‘åˆ—è¡¨ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œä»Žè¯¥å…ƒç´ å¼€å§‹æŸ¥æ‰¾å¤§å°è¶³å¤Ÿçš„ç¬¬ä¸€ä¸ªç©ºé—²å—ï¼Œå®ŒæˆåŽæŒ‡é’ˆæŒ‡å‘è¯¥å—çš„ä¸‹ä¸€ä¸ªç©ºé—²å—ï¼Œä¸‹æ¬¡æŸ¥æ‰¾æ—¶å°±ä»ŽæŒ‡é’ˆæŒ‡å‘çš„è¿™ä¸ªå—å¼€å§‹æŸ¥æ‰¾ã€‚

ä¼˜ç‚¹æ˜¯å¼€é”€å°ï¼Œå¹¶ä¸”å°†ç©ºé—²å—çš„æŸ¥æ‰¾æ‰©æ•£åˆ°æ•´ä¸ªåˆ—è¡¨ï¼Œä¸ä¼šå‡ºçŽ°é¦–æ¬¡åŒ¹é…é‚£æ ·çš„å¼€å¤´ç¢Žç‰‡å¤šçš„æƒ…å†µã€‚

##### åˆ†ç¦»ç©ºé—²åˆ—è¡¨

æœ‰çš„ç¨‹åºä¼šé¢‘ç¹ç”³è¯·ä¸€ç§ï¼ˆæˆ–å‡ ç§ï¼‰å›ºå®šå¤§å°çš„ç©ºé—´ï¼Œå¯¹äºŽè¿™ä¸€ç±»ç”³è¯·å¯ä»¥ä¸“é—¨é¢„ç•™å‡ºç©ºé—´å¹¶å‡†å¤‡æ–°çš„åˆ—è¡¨ã€‚

å¥½å¤„æ˜¯è¿™ç§åˆ—è¡¨ä¸å­˜åœ¨ç¢Žç‰‡ï¼Œåˆ†å‰²ä¸Žåˆå¹¶éƒ½å®¹æ˜“å®žçŽ°ï¼Œå¼€é”€å°ã€‚

å¦‚æžœé¢„ç•™çš„ç©ºé—´ä¸å¤Ÿï¼Œè¿˜å¯ä»¥ä»Žç©ºé—²åˆ—è¡¨ä¸­å†ç”³è¯·ç©ºé—´ã€‚

##### ä¼™ä¼´ç³»ç»Ÿ

ä¸ºäº†æé«˜åˆå¹¶æ—¶çš„æ•ˆçŽ‡ï¼Œä½¿ç”¨äºŒåˆ†ä¼™ä¼´åˆ†é…ç¨‹åºã€‚

![äºŒåˆ†ä¼™ä¼´](img3/äºŒåˆ†ä¼™ä¼´.png)

æ¯æ¬¡åˆ†é…ç©ºé—²ç©ºé—´æ—¶ï¼Œéƒ½å°†ä¸€ä¸ªå¤§ç©ºé—´ä¸æ–­ä¸€åˆ†ä¸ºäºŒï¼Œç›´åˆ°åˆ†å‡ºæ°å¥½æ»¡è¶³è¦æ±‚çš„å—ï¼Œè™½ç„¶è¿™æ ·ä¼šäº§ç”Ÿå†…éƒ¨ç¢Žç‰‡ï¼Œä½†æ˜¯åœ¨åˆå¹¶æ—¶ï¼Œåªè¦çŸ¥é“è¯¥å—çš„ä¼™ä¼´æœ‰æ²¡æœ‰ç©ºé—²ï¼Œå°±çŸ¥é“å½“å‰å—æ˜¯å¦èƒ½å¤Ÿåˆå¹¶ã€‚


#### åˆ†é¡µ

åˆ†æ®µçš„æ–¹å¼å¾ˆå®¹æ˜“äº§ç”Ÿå¤–éƒ¨ç¢Žç‰‡ï¼Œè¿™æ˜¯å› ä¸ºæ¯ä¸ªæ®µçš„å¤§å°ä¸ç»Ÿä¸€ï¼Œç¢Žç‰‡å¤šäº†ä¹‹åŽå¾ˆéš¾æ‰¾åˆ°åˆé€‚çš„ç©ºé—²ç©ºé—´æ»¡è¶³æ–°çš„éœ€æ±‚ã€‚

é€šè¿‡åˆ†é…ç»Ÿä¸€å¤§å°çš„å°ç©ºé—´ï¼Œå¯ä»¥å°†ç¢Žç‰‡åˆ©ç”¨èµ·æ¥ã€‚å°†ç‰©ç†å†…å­˜çœ‹æˆæ˜¯ç”±æ§½å—ç»„æˆçš„é˜µåˆ—ï¼Œè™šæ‹Ÿå†…å­˜çœ‹æˆæ˜¯ç”±å¾ˆå¤šå¤§å°ç›¸åŒçš„å°ç©ºé—´ç»„æˆçš„å¤§ç©ºé—´ã€‚æŠŠç‰©ç†å†…å­˜çš„æ¯ä¸ªæ§½å—ç§°ä¸ºé¡µå¸§ï¼Œè™šæ‹Ÿå°ç©ºé—´ç§°ä¸ºè™šæ‹Ÿé¡µã€‚

å¯ä»¥å°†å…¶ç†è§£ä¸ºä¸€å¼ å¤§å›¾åˆ†å‰²ä¸ºäº†å¾ˆå¤šå¤§å°ç›¸åŒçš„æ‹¼å›¾ç¢Žç‰‡ï¼Œæ¯ä¸ªæ®µä½¿ç”¨çš„ç©ºé—´å°±å¥½åƒæ¯ä¸ªæ‹¼å›¾ç¢Žç‰‡éƒ½æœ‰ä¸€å°éƒ¨åˆ†å†…å®¹ï¼Œè¿™äº›ç¢Žç‰‡å…±åŒç»„åˆèµ·æ¥å°±å½¢æˆäº†ä¸€æ•´ä¸ªæ®µã€‚ä¸ŽçœŸå®žæ‹¼å›¾ä¸åŒçš„æ˜¯ï¼Œç”±äºŽæŒ‡é’ˆçš„å­˜åœ¨ï¼Œè¿™äº›æ‹¼å›¾ç¢Žç‰‡ä¸å¿…è¿žç»­æ”¾åœ¨ä¸€èµ·ï¼Œåªè¦æŒ‡é’ˆæŒ‡å‘çš„ä½ç½®æ­£ç¡®ï¼Œå“ªæ€•å®ƒä»¬åˆ†æ•£åœ¨ç‰©ç†å†…å­˜çš„å„ä¸ªè§’è½ï¼Œä¹Ÿè·Ÿæ”¾åœ¨ä¸€èµ·æ²¡åŒºåˆ«ã€‚

![åˆ†é¡µ](img3/åˆ†é¡µ.png)

é‚£ä¹ˆè¿™äº›å…³é”®çš„æŒ‡é’ˆæ”¾åœ¨å“ªé‡Œï¼Ÿä¸ŽåŸºå€/ç•Œé™å¯„å­˜å™¨å’Œæ®µå¯„å­˜å™¨ä¸åŒçš„æ˜¯ï¼Œè¿™äº›æŒ‡é’ˆæ”¾åœ¨äº†å†…å­˜ä¸­ï¼Œå‡†ç¡®æ¥è¯´ï¼Œæ˜¯å†…å­˜çš„é¡µè¡¨ä¸­ã€‚æ¯ä¸ªè¿›ç¨‹åœ¨å†…å­˜ä¸­éƒ½æœ‰ç‹¬å±žäºŽè‡ªå·±çš„é¡µè¡¨ï¼Œé¡µè¡¨ä¸Šè®°å½•äº†è™šæ‹Ÿé¡µå·å¯¹åº”çš„ç‰©ç†é¡µå¸§å·ã€‚

åœ¨è¿›ç¨‹è®¿é—®å†…å­˜æ—¶ï¼ŒCPUæ ¹æ®è™šæ‹Ÿé¡µå·å’Œé¡µè¡¨å¾—åˆ°çœŸå®žçš„ç‰©ç†é¡µå·ï¼Œç„¶åŽæŠŠç‰©ç†é¡µå·åŠ ä¸Šé¡µå†…åç§»é‡ï¼Œå°±å¾—åˆ°äº†çœŸå®žçš„ç‰©ç†åœ°å€ã€‚

![é¡µåœ°å€è½¬æ¢](img3/é¡µåœ°å€è½¬æ¢.png)

æˆ‘ä»¬å¯ä»¥å°†é¡µè¡¨ç®€å•ç†è§£ä¸ºä¸€ä¸ªæ•°ç»„ï¼Œè™šæ‹Ÿé¡µå·å°±æ˜¯è¯¥æ•°ç»„çš„ç´¢å¼•ï¼Œç´¢å¼•å¯¹åº”çš„å…ƒç´ å°±å«é¡µè¡¨é¡¹ï¼Œé¡µè¡¨é¡¹é‡Œé™¤äº†æœ‰ç‰©ç†é¡µå¸§å·å¤–ï¼Œè¿˜æœ‰ä¸€äº›æ“ä½œä½ï¼Œæ¯”å¦‚ä¿æŠ¤ä½ã€æœ‰æ•ˆä½ã€è„ä½ã€å­˜åœ¨ä½ç­‰ã€‚

ç”±äºŽé¡µè¡¨æ”¾åœ¨å†…å­˜ä¸­ï¼Œæ‰€ä»¥æ¯æ¬¡è¦è®¿é—®å†…å­˜æ—¶ï¼ŒCPUéœ€è¦å…ˆåœ¨é¡µè¡¨å¯„å­˜å™¨è®¿é—®ä¸€æ¬¡å†…å­˜æ‰¾é¡µè¡¨ï¼Œç„¶åŽæ ¹æ®é¡µè¡¨å†è®¿é—®ä¸€æ¬¡å†…å­˜æ‰¾åˆ°å®žé™…ä½ç½®ã€‚æ¯æ¬¡å†…å­˜è®¿é—®éƒ½è¦è®¿é—®ä¸¤æ¬¡ï¼Œé€ æˆäº†å¾ˆå¤§å¼€é”€ã€‚å¦å¤–å¦‚æžœé¡µè¡¨å¾ˆå¤§çš„è¯ï¼Œé‚£ä¹ˆå†…å­˜ç©ºé—´å°±ä¼šæµªè´¹åœ¨å­˜å‚¨é¡µè¡¨è€Œä¸æ˜¯å­˜å‚¨ä»£ç ç­‰æœ‰ç”¨æ•°æ®ä¸Šã€‚


#### å¿«é€Ÿåœ°å€è½¬æ¢

åˆ†é¡µä¼šè®©æ¯ä¸€æ¬¡å†…å­˜è®¿é—®éƒ½å¤šä¸€æ¬¡æŸ¥è¯¢é¡µè¡¨çš„æ¶ˆè€—ï¼Œè™½ç„¶æé«˜äº†ç©ºé—´åˆ©ç”¨æ•ˆçŽ‡ï¼Œä½†æ˜¯é€Ÿåº¦å¤ªæ…¢äº†ã€‚è¦æ”¹å–„è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦æ·»åŠ ä¸€ä¸ªç¡¬ä»¶ç¼“å†²ï¼Œå°±åƒcacheé‚£æ ·ï¼ŒæŠŠæœ€è¿‘è¦è®¿é—®çš„é¡µè¡¨é¡¹æ”¾åœ¨è¿™ä¸ªç¼“å†²ä¸­ï¼Œè¿™ä¸ªç¼“å†²å«åšåœ°å€è½¬æ¢æ—è·¯ç¼“å†²TLBã€‚

TLBç”¨æ³•å¾ˆç®€å•ï¼ŒCPUè®¿é—®å†…å­˜æ—¶å…ˆåœ¨TLBæŸ¥æ‰¾æœ‰æ²¡æœ‰å¯¹åº”çš„è™šæ‹Ÿé¡µå·ï¼Œå¦‚æžœæœ‰å°±æ‹¿å‡ºå¯¹åº”çš„é¡µå¸§å·ï¼Œç„¶åŽè·Ÿåç§»é‡åˆæˆä¸ºç‰©ç†åœ°å€ï¼Œæœ€åŽè®¿é—®å†…å­˜ã€‚å¦‚æžœæ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„è™šæ‹Ÿé¡µå·ï¼Œé‚£å°±è®¿é—®å†…å­˜çš„é¡µè¡¨ï¼Œæ‰¾åˆ°å¯¹åº”çš„é¡µè¡¨é¡¹ï¼Œæ›´æ–°TLBã€‚

TLBä¸­ä¸€èˆ¬ä¼šæœ‰32ã€64æˆ–128é¡¹é¡µè¡¨é¡¹ï¼Œç”±äºŽTLBé‡‡ç”¨å…¨ç›¸è”æ˜ å°„ï¼Œæ‰€ä»¥è¿™äº›é¡µè¡¨é¡¹çš„å†…å®¹æ ¼å¼ä¸€èˆ¬ä¸º`VPN|PFN|å…¶å®ƒä½`ã€‚å…¶å®ƒä½ä¸­è¦æ³¨æ„æœ‰æ•ˆä½ä¸ç­‰åŒäºŽé¡µè¡¨çš„æœ‰æ•ˆä½ï¼ŒTLBçš„æœ‰æ•ˆä½å®žé™…è¡¨ç¤ºçš„æ˜¯TLBç¼“å­˜æœ‰æ•ˆï¼Œè¿™ä¸ªåœ°å€æˆ–è®¸å¯ä»¥è®¿é—®ï¼Œåªæ˜¯åœ¨ä½ ç¼“å­˜ä¹‹å‰ä¸çŸ¥é“è€Œå·²ï¼›é¡µè¡¨çš„æœ‰æ•ˆä½åˆ™è¡¨ç¤ºè¯¥è¿›ç¨‹æœ‰æ²¡æœ‰æƒé™è®¿é—®ã€‚

åœ¨å¤šè¿›ç¨‹åˆ‡æ¢è¿è¡Œæ—¶ï¼ŒTLBä¼šå°†åŽŸæ¥çš„è¿›ç¨‹çš„é¡µè¡¨é¡¹æœ‰æ•ˆä½å…¨éƒ¨ç½®é›¶ï¼Œä»Žè€Œè¾¾åˆ°æ¸…ç©ºç¼“å­˜çš„ç›®çš„ï¼Œç„¶åŽç­‰å¾…æ–°çš„è¿›ç¨‹è®¿é—®å†…å­˜ï¼Œä»Žè€Œæ›´æ–°ç¼“å­˜ã€‚ä½†å¦‚æžœé¢‘ç¹åœ°åˆ‡æ¢è¿›ç¨‹å°±è¦ä¸æ–­æ›´æ–°ï¼Œå¼€é”€å¾ˆå¤§ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªéº»çƒ¦ï¼Œéœ€è¦åœ¨å¤šä¸ªè¿›ç¨‹é—´å…±äº«TLBï¼Œç®€å•æ¥è¯´å°±æ˜¯åœ¨TLBä¸­å­˜å‚¨å¤šä¸ªè¿›ç¨‹çš„é¡µè¡¨é¡¹ï¼Œä¸è¿‡è¿™éœ€è¦åœ¨é¡µè¡¨é¡¹ä¸­å¤šåŠ ä¸€ä½ASIDï¼ˆåœ°å€ç©ºé—´æ ‡è¯†ç¬¦ï¼‰æ¥è¾¨åˆ«ä¸åŒé¡µè¡¨é¡¹åˆ†åˆ«å±žäºŽè°ã€‚

![æ·»åŠ ASID](img3/æ·»åŠ ASID.png)

TLBåœ¨å æ»¡çš„æƒ…å†µä¸‹ï¼Œè¦æ›´æ–°é¡µè¡¨é¡¹å°±è¦é¡¶æ›¿åŽŸæ¥çš„é¡µè¡¨é¡¹ã€‚è¿™é‡Œä»‹ç»ä¸¤ä¸ªç­–ç•¥ç»™äºˆå‚è€ƒï¼Œä¸€æ˜¯æœ€è¿‘æœ€å°‘ä½¿ç”¨LRUï¼Œè®©æ–°çš„é¡µè¡¨é¡¹é¡¶æ›¿åŽŸæ¥æœ€å°‘ç”¨åˆ°çš„ï¼›å¦ä¸€ç§æ˜¯éšæœºæ›¿æ¢ï¼Œä¹Ÿå°±æ˜¯éšæœºæ‰¾ä¸€ä¸ªè¿›è¡Œæ›¿æ¢ã€‚éšæœºæ›¿æ¢å¯ä»¥é¿å…ä¸€ç§æžç«¯æƒ…å†µï¼Œæ¯”å¦‚å¾ªçŽ¯éåŽ†æ•°ç»„ï¼Œæ•°ç»„å¤§å°å 20ä¸ªé¡µï¼Œè€ŒTLBåªæœ‰19ä¸ªé¡µè¡¨é¡¹ï¼Œå¦‚æžœä½¿ç”¨LRUå°±ä¼šå¯¼è‡´æ¯æ¬¡æ–°è®¿é—®çš„éƒ½æ˜¯åˆšåˆšè¢«æ›¿æ¢çš„ï¼Œéœ€è¦ä¸æ–­æ›´æ–°ï¼Œéšæœºæ›¿æ¢å°±èƒ½å¾ˆå¥½åœ°é¿å…è¿™ä¸€ç‚¹ã€‚

> ä¸€ä¸ªå®žé™…çš„TLBè¡¨é¡¹ä¸€èˆ¬é•¿è¿™ä¸ªæ ·å­ã€‚åœ°å€ç©ºé—´ä¸º32ä½ï¼Œé¡µå¤§å°ä¸º4KBï¼Œ12ä½ä¸ºåç§»é‡ï¼ŒVPNå 19ä½ï¼Œå› ä¸ºç”¨æˆ·ç©ºé—´ä¸€èˆ¬å ä¸€åŠï¼Œå‰©ä¸‹ä¸€åŠç”±å†…æ ¸ç®¡ç†ã€‚
>
> Gä¸ºå…¨å±€ä½ï¼Œè¡¨ç¤ºè¯¥é¡µæ˜¯ä¸æ˜¯æ‰€æœ‰è¿›ç¨‹å…±äº«ï¼Œ3ä¸ªCä½ä¸ºä¸€è‡´ä½ï¼Œè¡¨ç¤ºç¡¬ä»¶å¦‚ä½•è¿›è¡Œç¼“å­˜ï¼Œè„ä½Dè¡¨ç¤ºè¯¥é¡µæ˜¯å¦è¢«å†™å…¥æ–°æ•°æ®ä½†è¿˜æ²¡ç¼“å­˜ï¼Œæœ‰æ•ˆä½Vè¡¨ç¤ºè¯¥æ˜ å°„æ˜¯å¦æœ‰æ•ˆã€‚è¿˜æœ‰å›¾ä¸­æœªå±•ç¤ºçš„é¡µæŽ©ç ä½ï¼Œç”¨æ¥æ”¯æŒä¸åŒé¡µå¤§å°ã€‚
>
> ![TLBè¡¨é¡¹](img3/TLBè¡¨é¡¹.png)

#### å¤šçº§åˆ†é¡µ

åˆ†é¡µçš„æ–¹æ³•å›ºç„¶è®©å†…å­˜ç©ºé—´æ•ˆçŽ‡å˜é«˜äº†ï¼Œä½†æ˜¯å¦‚æžœé¡µè¡¨æœ¬èº«å¤ªå¤§çš„è¯ï¼Œä¹Ÿä¼šå ç”¨å¾ˆå¤šå†…å­˜ã€‚æˆ‘ä»¬å½“ç„¶å¸Œæœ›å†…å­˜ä¸­å¤šå­˜ä¸€äº›æœ‰ç”¨çš„æ•°æ®ï¼Œè€Œä¸æ˜¯æ›´å¤šæŒ‡é’ˆã€‚

###### æ›´å¤§çš„é¡µ

ä¸€ä¸ªç®€å•çš„æ–¹æ³•æ˜¯è®©æ¯ä¸ªé¡µå˜å¤§ï¼Œåªè¦é¡µå˜å¤§ï¼Œé‚£ä¹ˆé¡µè¡¨é¡¹çš„æ•°é‡å°±ä¼šå°‘ï¼Œé¡µè¡¨ä¹Ÿä¸ä¼šå å¤ªå¤šå†…å­˜ã€‚æ˜¾è€Œæ˜“è§çš„æ˜¯å¤ªå¤§çš„é¡µåˆä¼šå¯¼è‡´åˆ†é…å†…å­˜æ—¶ä¸€å¼€å§‹æ‰€é‡åˆ°çš„é—®é¢˜â€”â€”å®¹æ˜“å‡ºçŽ°å†…éƒ¨ç¢Žç‰‡ã€‚

è¿™ä¸ªæ—¶å€™å‰é¢æˆ‘ä»¬ä»‹ç»çš„é¡µè¡¨é¡¹ä¸­æŽ§åˆ¶é¡µè¡¨å¤§å°çš„ä½å°±ç”¨åˆ°äº†ï¼Œå¯¹äºŽé‚£äº›å†…å­˜éœ€æ±‚å¤§çš„è¿›ç¨‹å¯ä»¥é€šè¿‡æŽ§åˆ¶ä½åˆ†é…æ›´å¤§çš„é¡µï¼Œåä¹‹å°±åˆ†é…è¾ƒå°çš„é¡µï¼Œè€Œè¿™åªéœ€è¦ç‰ºç‰²ä¸€äº›å¼€å‘è€…çš„å¤´å‘ï¼Œè®©ç³»ç»Ÿè®¾è®¡æ›´åŠ å¤æ‚ç½¢äº†ã€‚å½“ç„¶è¿™ç§å¤§å°ä¸ä¸€çš„é¡µæ˜¯å¦ä¼šå¯¼è‡´åŒåˆ†æ®µä¸€æ ·çš„å¤–éƒ¨ç¢Žç‰‡çš„äº§ç”Ÿï¼Œéœ€è¦æŒä¿ç•™æ„è§ã€‚

###### æ··åˆåˆ†æ®µå’Œåˆ†é¡µ

æœ‰çš„æ—¶å€™é€ æˆç¢Žç‰‡çš„åŽŸå› ä¸åœ¨äºŽè¿›ç¨‹æ•°æ®ä½¿ç”¨çš„å†…å­˜ç©ºé—´ï¼Œè€Œåœ¨äºŽé¡µè¡¨æ‰€ä½¿ç”¨çš„ç©ºé—´ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![é¡µè¡¨ç©ºé—´æµªè´¹](img3/é¡µè¡¨ç©ºé—´æµªè´¹.png)

å¯ä»¥çœ‹åˆ°ï¼Œè¿›ç¨‹å¯¹äºŽè™šæ‹Ÿç©ºé—´çš„æµªè´¹å®Œå…¨ä½“çŽ°åœ¨äº†é¡µè¡¨ä¸Šï¼Œè€Œç”±äºŽé¡µè¡¨è¢«æ”¾åœ¨å†…å­˜ä¸­ï¼Œå› æ­¤è¿™ç§æµªè´¹ä¹Ÿä¸€åŒå‡ºçŽ°åœ¨å†…å­˜ä¸­ã€‚è¿™æ¯”ä¸€å¼€å§‹ç›´æŽ¥åœ¨å†…å­˜ä¸­ä¸ºå †æ ˆé¢„ç•™ç©ºé—´çš„åšæ³•å¥½å¾ˆå¤šï¼Œä½†å¦‚æžœé¡µè¡¨å¾ˆå¤§ï¼Œå°¤å…¶æ˜¯åŸºäºŽå¤šè¿›ç¨‹å¹¶å‘è¿è¡Œçš„éœ€æ±‚è€Œå°†å¾ˆå¤šè¿›ç¨‹çš„é¡µè¡¨éƒ½æ”¾åœ¨å†…å­˜æ—¶ï¼Œå°±ä¼šé€ æˆç›¸å½“å¤§çš„æµªè´¹ã€‚

åŸºäºŽè¿‡åŽ»å·²æœ‰çš„ç»éªŒï¼Œæˆ‘ä»¬ä¸éœ€è¦å†åƒåˆ«çš„åŠžæ³•å¤„ç†è¿™äº›æµªè´¹ã€‚å°±åƒåˆšå¼€å§‹åœ¨å†…å­˜ä¸­é‡åˆ°è¿™ç§é—®é¢˜æ‰€é‡‡ç”¨çš„æ–¹æ³•ä¸€æ ·ï¼Œå¯¹äºŽé¡µè¡¨çš„æµªè´¹ï¼Œæˆ‘ä»¬ç»§ç»­ä½¿ç”¨åˆ†æ®µã€‚å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬è¦ä¸ºæ¯ä¸ªæ®µå‡†å¤‡ä¸€ä¸ªé¡µè¡¨ï¼Œå¹¶å°†æ¯ä¸ªé¡µè¡¨çš„åœ°å€æ”¾åœ¨å¯¹åº”çš„åŸºå€/ç•Œé™å¯„å­˜å™¨ä¸­ï¼Œè¿™æ ·å°±èƒ½é¿å…å¯¹ä¸€æ•´ä¸ªè¿›ç¨‹ä½¿ç”¨ä¸€ä¸ªé¡µè¡¨æ—¶çš„æµªè´¹ã€‚

å¥½å¤„è¯´å®Œäº†ï¼ŒæŽ¥ä¸‹æ¥è¯¥è¯´è¯´åå¤„äº†ã€‚æˆ‘ä»¬åº”è¯¥è¿˜è®°å¾—åˆšå¼€å§‹åˆ†æ®µè§£å†³å†…éƒ¨ç¢Žç‰‡é—®é¢˜åŽç´§è·Ÿç€äº§ç”Ÿçš„æ–°é—®é¢˜ï¼Œæ²¡é”™ï¼å°±æ˜¯å¤–éƒ¨ç¢Žç‰‡ï¼ç‰›é€¼çš„ä½ å¯èƒ½å·²ç»æ„è¯†åˆ°äº†ï¼Œéšç€åˆ†æ®µæ–¹å¼å¯¹é¡µè¡¨çš„ä½¿ç”¨ï¼Œå¤–éƒ¨ç¢Žç‰‡ä¹Ÿä¸€åŒå‡ºçŽ°åœ¨äº†é¡µè¡¨ä¸­ï¼Œå‡†ç¡®æ¥è¯´æ˜¯å‡ºçŽ°åœ¨äº†é¡µè¡¨ä¹‹é—´ã€‚å¤§é‡å¤–éƒ¨ç¢Žç‰‡çš„å‡ºçŽ°ä¼šå¯¼è‡´åœ¨å†…å­˜ä¸­æœ‰å¾ˆå¤šé›¶æ•£çš„ç©ºé—´ï¼Œä½†è¿™äº›ç©ºé—´æ— æ³•ä¸ºæ–°çš„æ®µåˆ†é…é¡µè¡¨ã€‚

##### å¤šçº§åˆ†é¡µ

æŒ‰ç…§ä¸Šä¸€ä¸ªæ ‡é¢˜çš„é£Žæ ¼ï¼Œè¿™ä¸ªæœ¬æ¥åº”è¯¥å«â€œæ··åˆåˆ†é¡µä¸Žåˆ†é¡µâ€ï¼Œä¸è¿‡è¿™ä¸å¤ªå¥½å¬ï¼Œå¹¶ä¸”æˆ‘ä»¬è¦å°Šé‡åŽŸè‘—ï¼Œå› ä¸ºåŽŸè‘—å°±æ˜¯â€œå¤šçº§åˆ†é¡µâ€ã€‚

ç‰›é€¼çš„ä½ å¤§æ¦‚å·²ç»æƒ³åˆ°è¿™ä¸€èŠ‚è¦å¹²ä»€ä¹ˆäº†ï¼Œæ²¡é”™ï¼Œæˆ‘ä»¬è¦å¤„ç†ä¸Šä¸€èŠ‚çš„åˆ†æ®µå¯¼è‡´çš„é—®é¢˜ï¼Œå¹¶ä¸”ä¾æ—§æ˜¯ç”¨è€æ–¹æ³•â€”â€”å¯¹é¡µè¡¨ä½¿ç”¨åˆ†é¡µã€‚

![å¤šçº§é¡µè¡¨](img3/å¤šçº§é¡µè¡¨ç¤ºä¾‹.png)

åƒä¸Šé¢çš„ä¾‹å­é‚£æ ·ï¼ŒæŠŠæ‰€æœ‰é¡µè¡¨é¡¹éƒ½è£…è¿›é¡µé‡Œï¼Œç„¶åŽä¸ºè¿™äº›è£…ç€é¡µè¡¨é¡¹çš„é¡µåšä¸€ä¸ªé¡µè¡¨ï¼Œè¿™ä¸ªé¡µè¡¨å¯ä»¥å«é¡µç›®å½•ï¼Œä¹Ÿå¯ä»¥å«äºŒçº§é¡µè¡¨ã€‚

![è™šæ‹Ÿåœ°å€](img3/è™šæ‹Ÿåœ°å€åˆ’åˆ†.png)

åŒæ—¶è™šæ‹Ÿåœ°å€ä¹Ÿè¢«åˆ†æˆä¸‰ä»½ï¼Œæ ¹æ®é¡µç›®å½•ç´¢å¼•å’Œé¡µç›®å½•æ‰¾åˆ°ä¸€çº§é¡µè¡¨çš„çœŸå®žåœ°å€ï¼Œç„¶åŽæ ¹æ®é¡µè¡¨ç´¢å¼•å’Œä¸€çº§é¡µè¡¨æ‰¾åˆ°çœŸå®žå¾…è®¿é—®åœ°å€ã€‚å¼€é”€è‚‰çœ¼å¯è§çš„å¤§ï¼Œè®¿é—®ä¸€æ¬¡æ•°æ®éœ€è¦è®¿é—®ä¸‰æ¬¡å†…å­˜ã€‚

æˆ‘ä»¬ä½¿ç”¨è€ç»éªŒè§£å†³é—®é¢˜çš„åŒæ—¶å½“ç„¶ä¹Ÿè¦æƒ³åˆ°è€æ–¹æ³•å¯èƒ½å¯¼è‡´çš„æ–°é—®é¢˜ï¼Œä¸€çº§é¡µè¡¨å¤„ç†å¥½äº†ï¼ŒäºŒçº§é¡µè¡¨è¿˜æ²¡æœ‰å‘¢ã€‚äºŒçº§é¡µè¡¨ä½¿ç”¨çš„ä»ç„¶æ˜¯åŸºå€/ç•Œé™å¯„å­˜å™¨ï¼Œä»ç„¶æœ‰å¯èƒ½äº§ç”Ÿç¢Žç‰‡é—®é¢˜ã€‚

ä¿—è¯è¯´ç¥–å®—ä¹‹æ³•ä¸å¯å˜ï¼Œä½†æˆ‘ä»¬ä¸èƒ½æ€»ç”¨è€ç¥–å®—çš„æ™ºæ…§ï¼ˆå“ªæ€•è¿™æ˜¯ä¸ªçŽ°ä»£ç¤¾ä¼šçš„è€ç¥–å®—ï¼‰è§£å†³é—®é¢˜ï¼Œè¿™æ ·è®¨è®ºä¸‹åŽ»æ²¡å®Œæ²¡äº†äº†ã€‚ç›´æŽ¥ç›–æ£ºå®šè®ºå§ã€‚å¯¹äºŽäºŒçº§é¡µè¡¨å‡ºçŽ°çš„é—®é¢˜ï¼Œæˆ‘ä»¬ä»ç„¶é‡‡ç”¨åˆ†é¡µçš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯å¼€å¤´è®²çš„å¤šçº§é¡µè¡¨ã€‚

å°½ç®¡æ‰€æœ‰å¤šçº§é¡µè¡¨çš„æœ€é¡¶å±‚éƒ½é‡‡ç”¨çš„æ˜¯åŸºå€/ç•Œé™å¯„å­˜å™¨è¿½è¸ªåœ°å€çš„æ–¹å¼ï¼Œä½†éšç€å±‚æ•°å¢žåŠ ï¼Œç³»ç»Ÿå¯¹å†…å­˜çš„åˆ©ç”¨çŽ‡ä¹Ÿè¶Šæ¥è¶Šé«˜ï¼Œå¤šçº§é¡µè¡¨æ¯”ä¸€çº§é¡µè¡¨äº§ç”Ÿçš„é—®é¢˜è¦å°å¾ˆå¤šã€‚

```c
1    VPN = (VirtualAddress & VPN_MASK) >> SHIFT 
2    (Success, TlbEntry) = TLB_Lookup(VPN) 
3    if (Success == True)    // TLB Hit 
4        if (CanAccess(TlbEntry.ProtectBits) == True) 
5            Offset   = VirtualAddress & OFFSET_MASK 
6            PhysAddr = (TlbEntry.PFN << SHIFT) | Offset 
7            Register = AccessMemory(PhysAddr) 
8        else 
9            RaiseException(PROTECTION_FAULT) 
10   else                  // TLB Miss 
11       // first, get page directory entry 
12       PDIndex = (VPN & PD_MASK) >> PD_SHIFT 
13       PDEAddr = PDBR + (PDIndex * sizeof(PDE)) 
14       PDE     = AccessMemory(PDEAddr) 
15       if (PDE.Valid == False) 
16           RaiseException(SEGMENTATION_FAULT) 
17       else 
18           // PDE is valid: now fetch PTE from page table 
19           PTIndex = (VPN & PT_MASK) >> PT_SHIFT 
20           PTEAddr = (PDE.PFN << SHIFT) + (PTIndex * sizeof(PTE)) 
21           PTE     = AccessMemory(PTEAddr) 
22           if (PTE.Valid == False) 
23               RaiseException(SEGMENTATION_FAULT) 
24           else if (CanAccess(PTE.ProtectBits) == False) 
25               RaiseException(PROTECTION_FAULT) 
26           else 
27               TLB_Insert(VPN, PTE.PFN, PTE.ProtectBits) 
28               RetryInstruction()
```

ä¸Šé¢è¿™æ®µæ˜¯å¤šçº§é¡µè¡¨æƒ…å†µä¸‹è®¿é—®å†…å­˜çš„ä¼ªä»£ç ï¼Œè¿™æ®µä»£ç è®©æˆ‘ä»¬æ„è¯†åˆ°å¤šçº§é¡µè¡¨ä¸æ˜¯æ— æ•Œçš„ï¼Œéšç€é¡µè¡¨å±‚æ•°å¢žåŠ ï¼ŒCPUè®¿é—®å†…å­˜çš„å¼€é”€å’Œå¤æ‚åº¦ä¹Ÿä¼šå˜å¤§ã€‚åœ¨TLBæœªå‘½ä¸­æ—¶ï¼Œå¤„ç†è¿‡ç¨‹ä¼šç›¸å½“éº»çƒ¦ã€‚

##### åå‘é¡µè¡¨

é‚£ä¹ˆæœ‰ä»€ä¹ˆä¸œè¥¿å¯ä»¥æ‘†è„±ç¥–å®—ä¹‹æ³•å‘¢ï¼Ÿå”‰ï¼ðŸ¤“ðŸ‘†ï¼Œè¿™é‡Œåˆšå¥½æœ‰ä¸€ä¸ªã€‚

åå‘é¡µè¡¨é‡‡ç”¨çš„æ˜¯åå‘æ˜ å°„çš„æ–¹æ³•ã€‚ä¸€èˆ¬æ¥è¯´ä»Žè™šæ‹Ÿåœ°å€æ˜ å°„åˆ°é¡µè¡¨æ˜¯æ­£å‘æ˜ å°„ã€‚åå‘æ˜ å°„ä¿ç•™ä¸€ä¸ªå…¨å±€çš„å”¯ä¸€é¡µè¡¨ï¼Œè¿™ä¸€ä¸ªé¡µè¡¨æ˜ å°„åˆ°å¤šä¸ªè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ï¼Œæ¯å½“æœ‰è¿›ç¨‹è®¿é—®å†…å­˜æ—¶å°±åœ¨è¿™ä¸€ä¸ªé¡µè¡¨ä¸ŠæŸ¥ã€‚

é‰´äºŽå…¨å±€åªæœ‰è¿™ä¸€ä¸ªé¡µè¡¨ï¼Œå¯æƒ³è€ŒçŸ¥è¿™ä¸ªé¡µè¡¨ä¼šç›¸å½“å¤§ï¼Œå®ƒä¸åƒTLBé‚£æ ·å¯ä»¥é‡‡ç”¨å…¨ç›¸è”æ˜ å°„çš„æ–¹å¼ï¼Œå¯¹ç€åå‘é¡µè¡¨é‡‡ç”¨éåŽ†æ—¶é—´å¼€é”€ä¼šéžå¸¸å¤§ã€‚ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜æˆ‘ä»¬é‡‡ç”¨æ•£åˆ—è¡¨ä½œä¸ºåå‘é¡µè¡¨çš„æ•°æ®ç»“æž„ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šç›´æŽ¥å°†ç´¢å¼•ä½œä¸ºè™šæ‹Ÿåœ°å€ã€‚



#### è¶…è¶Šç‰©ç†å†…å­˜

åœ¨ä¹‹å‰æ‰€è®¨è®ºçš„æƒ…å½¢ä¸­ï¼Œæˆ‘ä»¬ä¼šä¸ºè¿›ç¨‹åˆ†é…ä¸€ä¸ªå°äºŽç­‰äºŽç‰©ç†å†…å­˜çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œè¿™æ ·å¾ˆå¥½åœ°å®žçŽ°äº†å¤šé“ç¨‹åºè¿è¡Œæ—¶æ¯ä¸ªè¿›ç¨‹éƒ½èƒ½ä½¿ç”¨å®Œæ•´å†…å­˜çš„å¥½å¤„ã€‚ä½†ä¸ºäº†è®©æ›´å¤šçš„ç¨‹åºäº«å—æ›´å¤§çš„å†…å­˜ï¼Œæˆ‘ä»¬æ˜¯å¦è¿˜å¯ä»¥åšå‡ºä¸€äº›ä¼˜åŒ–ï¼Ÿ

ç­”æ¡ˆå½“ç„¶æ˜¯å¯è¡Œçš„ï¼Œä¸è¦å¿˜äº†ï¼Œé™¤äº†ç‰©ç†å†…å­˜å¤–ï¼Œæˆ‘ä»¬è¿˜æœ‰ç£ç›˜ï¼Œå¹¶ä¸”ç£ç›˜çš„å­˜å‚¨è¦è¿œè¿œè¶…è¿‡å†…å­˜ã€‚åªè¦ä¼˜åŒ–å¾—å½“ï¼Œæˆ‘ä»¬å°±å¯ä»¥èŠ±ç£ç›˜çš„é’±æ¥å¾—åˆ°å†…å­˜çš„æ€§èƒ½ã€‚

ä»Žç†è®ºä¸Šæ¥è®²ï¼Œæ—¢ç„¶å¯¹æ•°æ®çš„è®¿é—®å…·æœ‰æ—¶é—´å±€éƒ¨æ€§å’Œç©ºé—´å±€éƒ¨æ€§ï¼Œé‚£æˆ‘ä»¬åªéœ€è¦æŠŠæ‰€æœ‰è¿›ç¨‹æœ€å¸¸ç”¨çš„é¡µæ”¾åœ¨å†…å­˜ï¼Œä¸å¸¸ç”¨çš„æ”¾åœ¨ç£ç›˜ï¼Œå¹¶ä¿è¯å½“è¿™äº›é¡µçš„é‡è¦æ€§å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ“ä½œç³»ç»Ÿèƒ½å¤ŸåŠæ—¶åœ°æŠŠç£ç›˜ä¸­éœ€è¦çš„é¡µæ”¾åœ¨å†…å­˜ï¼ŒæŠŠå†…å­˜ä¸­ä¸å†å¸¸ç”¨çš„é¡µæ”¾å›žç£ç›˜ï¼Œå°±å¯ä»¥å®žçŽ°æ›´å¤§å­˜å‚¨ï¼Œç›¸åŒé€Ÿåº¦çš„å‡è±¡ã€‚

å°½ç®¡å®žé™…ä¸Šå¯èƒ½æ— æ³•è¾¾åˆ°è¿™ä¹ˆå®Œç¾Žï¼Œä½†ç›¸è¾ƒåªä½¿ç”¨ç‰©ç†å†…å­˜è€Œè¨€ä»ç„¶æ˜¯å·¨å¤§çš„æå‡ã€‚

##### æœºåˆ¶

æ›´å¤§çš„è™šæ‹Ÿç©ºé—´éœ€è¦åº•å±‚ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿçš„æ”¯æŒï¼Œæˆ‘ä»¬é¦–å…ˆè¦äº†è§£ä¸€äº›æœ€å¸¸ç”¨çš„æœºåˆ¶ã€‚

è¦å®žçŽ°è¶…è¶Šç‰©ç†å†…å­˜çš„å‡è±¡ï¼Œé¦–å…ˆéœ€è¦ç¡¬ç›˜è…¾å‡ºä¸€å—åœ°æ–¹ä¸“é—¨ç”¨æ¥å­˜æ”¾è¿›ç¨‹ä¸å¤ªå¸¸ç”¨çš„é¡µï¼Œè¿™å—åœ°æ–¹å«åšäº¤æ¢ç©ºé—´ã€‚ä¸€äº›é¡µä½¿ç”¨çŽ‡é™ä½Žæ—¶ä¼šè¢«æ”¾åœ¨è¿™é‡Œï¼Œå¦‚æžœæœ‰çš„é¡µä½¿ç”¨çŽ‡æé«˜ï¼Œå°±ä¼šè¢«æ”¾å›žå†…å­˜ã€‚

![äº¤æ¢ç©ºé—´](img3/äº¤æ¢ç©ºé—´.png)

---

çŽ°åœ¨æˆ‘ä»¬æ·±å…¥äº†è§£ä¸€ä¸‹äº¤æ¢ç©ºé—´æ˜¯å¦‚ä½•è¢«ç”¨åˆ°çš„ã€‚

å‡è®¾æœ‰ä¸€ä¸ªè¿›ç¨‹ç”±äºŽéœ€è¦çš„å­˜å‚¨ç©ºé—´è¿‡å¤§ï¼ŒåŒæ—¶ç”³è¯·çš„ç©ºé—´åˆè¡¨çŽ°å‡ºè‰¯å¥½çš„å±€éƒ¨æ€§ï¼Œæ‰€ä»¥å®ƒçš„è™šæ‹Ÿåœ°å€ç©ºé—´æ—¢ç”±å†…å­˜æä¾›ï¼Œä¹Ÿç”±ç£ç›˜æä¾›ã€‚çŽ°åœ¨æ“ä½œç³»ç»Ÿéœ€è¦è®¿é—®å®ƒçš„ä¸€å—åœ°å€ç©ºé—´ï¼Œé¦–å…ˆæ ¹æ®TLBæŸ¥è¯¢è¯¥ç©ºé—´çš„é¡µï¼Œå¦‚æžœå‘½ä¸­äº†ï¼Œé‚£å°±ç›´æŽ¥å¯¹è¯¥é¡µæ‰§è¡Œç›¸åº”æ“ä½œï¼›å¦‚æžœæ²¡æœ‰å‘½ä¸­ï¼Œé‚£å°±æ‰¾åˆ°é¡µç›®å½•åŸºå€å¯„å­˜å™¨ï¼Œç„¶åŽæ‰¾åˆ°å¯¹åº”é¡µè¡¨ï¼Œå†ä»Žé¡µè¡¨æ‰¾åˆ°å¯¹åº”çš„é¡µã€‚

è¯¥è¿›ç¨‹çš„é¡µåœ¨å†…å­˜å’Œç£ç›˜ä¸­éƒ½æœ‰ï¼Œè¦çŸ¥é“æ˜¯åŽ»å“ªé‡Œæ‰¾ï¼Œéœ€è¦å†åŠ ä¸€ä½æ¥è¿›è¡ŒåŒºåˆ†ï¼Œè¿™ä¸€ä½ç§°ä¸ºå­˜åœ¨ä½ã€‚å¦‚æžœå­˜åœ¨ä½æœ‰æ•ˆï¼Œåˆ™éœ€è¦çš„é¡µåœ¨å†…å­˜ä¸­ï¼Œç›´æŽ¥å°†è¯¥é¡µçš„é¡µè¡¨é¡¹åŠ è½½åœ¨TLBä¸­ï¼›å¦‚æžœæ— æ•ˆï¼Œåˆ™è¦å…ˆå°†ç£ç›˜ä¸­çš„é¡µæ”¾åœ¨å†…å­˜ä¸­ï¼Œç„¶åŽå°†é¡µè¡¨é¡¹äº¤ç»™TLBã€‚æ— æ•ˆçš„é¡µè¡¨é¡¹ä¸­çš„åœ°å€å°±æ˜¯è¯¥é¡µåœ¨ç£ç›˜ä¸­çš„åœ°å€ã€‚

> è®¿é—®ä¸å­˜åœ¨äºŽç‰©ç†å†…å­˜ä¸­çš„é¡µï¼Œè¿™ç§è¡Œä¸ºé€šå¸¸ç§°ä¹‹ä¸ºé¡µé”™è¯¯ã€‚é¡µé”™è¯¯ç”±æ“ä½œç³»ç»Ÿå¤„ç†ã€‚
>
> é¡µé”™è¯¯æŽ§åˆ¶æµç®—æ³•ï¼ˆç¡¬ä»¶ï¼‰å¦‚ä¸‹æ‰€ç¤ºï¼š
```c
VPN = (VirtualAddress & VPN_MASK) >> SHIFT;
(Success, TlbEntry) = TLB_Lookup(VPN);

if (Success == True) { // TLB Hit
    if (CanAccess(TlbEntry.ProtectBits) == True) {
        Offset = VirtualAddress & OFFSET_MASK;
        PhysAddr = (TlbEntry.PFN << SHIFT) | Offset;
        Register = AccessMemory(PhysAddr);
    } else {
        RaiseException(PROTECTION_FAULT);
    }
} else { // TLB Miss
    PTEAddr = PTBR + (VPN * sizeof(PTE));
    PTE = AccessMemory(PTEAddr);
    if (PTE.Valid == False) {
        RaiseException(SEGMENTATION_FAULT);
    } else {
        if (CanAccess(PTE.ProtectBits) == False) {
            RaiseException(PROTECTION_FAULT);
        } else if (PTE.Present == True) {
            // assuming hardware-managed TLB
            TLB_Insert(VPN, PTE.PFN, PTE.ProtectBits);
            RetryInstruction();
        } else if (PTE.Present == False) {
            RaiseException(PAGE_FAULT);
        }
    }
}

PFN = FindFreePhysicalPage();
if (PFN == -1) {               // no free page found
    PFN = EvictPage();        // run replacement algorithm
}

DiskRead(PTE.DiskAddr, PFN); // sleep (waiting for I/O)
PTE.present = True;           // update page table with present
PTE.PFN = PFN;               // bit and translation (PFN)
RetryInstruction();           // retry instruction
```

æœ‰æ—¶å€™ä¼šå‡ºçŽ°æ„å¤–çš„æƒ…å†µï¼Œæ¯”å¦‚å†…å­˜å·²ç»æ»¡äº†ï¼Œä¸èƒ½æŽ¥å—ä»Žç£ç›˜æ¥çš„é¡µã€‚è¿™æ—¶å€™éœ€è¦æŠŠä¸€äº›é¡µæ‹¿å‡ºï¼Œä¸Žç£ç›˜è¿›è¡Œé¡µäº¤æ¢ã€‚

å½“ç„¶åœ¨å®žé™…æƒ…å†µä¸­ç­‰åˆ°å†…å­˜æ»¡äº†å†æƒ³èµ·äº¤æ¢é¡µå°±å¤ªæ™šäº†ï¼Œé‚£ä¼šè®©å¥½ä¸å®¹æ˜“å½¢æˆçš„å‡è±¡å˜å¾—æ¼æ´žç™¾å‡ºã€‚å¤§å¤šæ•°æ“ä½œç³»ç»Ÿä¼šè®¾ç½®é«˜æ°´ä½çº¿HWå’Œä½Žæ°´ä½çº¿LWï¼Œå½“å†…å­˜ä¸­çš„ç©ºé—²ç©ºé—´å°‘äºŽLWæ—¶å°±ä¼šæŠŠä¸€äº›é¡µæ¢åˆ°ç£ç›˜ï¼ŒçŸ¥é“ç©ºé—²ç©ºé—´ä¸å°‘äºŽHWï¼Œè¿™ä¸ªåŽå°è¿›ç¨‹ç§°ä¸ºäº¤æ¢å®ˆæŠ¤è¿›ç¨‹æˆ–é¡µå®ˆæŠ¤è¿›ç¨‹ã€‚å…¶å®ƒè¿˜æœ‰ä¸€äº›æ€§èƒ½ä¼˜åŒ–ï¼Œæ¯”å¦‚æŠŠéœ€è¦æ¢å‡ºçš„é¡µåˆå¹¶åœ¨ä¸€èµ·åŽåŒæ—¶å†™å…¥äº¤æ¢ç©ºé—´ï¼Œæé«˜ç¡¬ç›˜çš„æ•ˆçŽ‡ï¼ŒIOå…è®¸è¿™ä¹ˆåšã€‚

##### ç­–ç•¥

åœ¨ä½¿ç”¨ç£ç›˜çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬ä¸å¯é¿å…åœ°è¦è€ƒè™‘åˆ°ï¼Œå½“éœ€è¦äº¤æ¢ä¸€äº›é¡µæ—¶ï¼Œæˆ‘ä»¬è¯¥æŠŠè°äº¤å‡ºå†…å­˜ï¼ŒæŠŠè°æ”¾å…¥å†…å­˜ï¼Ÿ

è¿™ä¸ªé—®é¢˜å¬èµ·æ¥æœ‰ç‚¹è ¢ï¼Œå› ä¸ºæ˜¯ä¸ªäººéƒ½èƒ½æƒ³åˆ°ï¼Œå½“ç„¶è¦ç”¨ä¸ç”¨çš„é¡µæ¢éœ€è¦ç”¨çš„é¡µã€‚é‚£ä¹ˆæ­å–œä½ ï¼Œä½ æƒ³åˆ°äº†é¡µäº¤æ¢ç­–ç•¥ä¸­æ•ˆçŽ‡æœ€é«˜çš„æœ€ä¼˜æ›¿æ¢ç­–ç•¥ã€‚å‡†ç¡®æ¥è¯´ï¼Œæœ€ä¼˜æ›¿æ¢ç­–ç•¥æŒ‡çš„æ˜¯æŠŠæœªæ¥å³å°†ä½¿ç”¨çš„é¡µæ”¾å…¥å†…å­˜ï¼ŒæŠŠå¾ˆä¹…ä¹‹åŽæ‰ä½¿ç”¨çš„é¡µæ”¾åœ¨ç¡¬ç›˜ã€‚

å¾ˆé—æ†¾çš„æ˜¯ï¼Œæˆ‘ä»¬æ— æ³•é¢„æµ‹æœªæ¥ï¼Œå› æ­¤æœ€ä¼˜æ›¿æ¢ç­–ç•¥æ˜¯æ— æ³•å®žçŽ°çš„ï¼Œæˆ‘ä»¬åªèƒ½é€šè¿‡å…¶å®ƒæ‰‹æ®µæ¥æŽ¥è¿‘å®ƒã€‚

---

æœ€ç®€å•çš„æ‰‹æ®µæ˜¯FIFOå’Œéšæœºï¼Œå®Œå…¨ä¸è€ƒè™‘ä»»ä½•å±€éƒ¨æ€§ï¼Œåªæ˜¯å•çº¯çš„å› ä¸ºå®žçŽ°èµ·æ¥ä¸å¤æ‚ï¼Œå½“ç„¶æ•ˆçŽ‡ä¹Ÿæ˜¯ç›¸å½“ä¸€èˆ¬ã€‚å½“ç„¶éšæœºå¯ä»¥é¿å…ä¸€äº›ç‰¹æ®Šæƒ…å†µï¼Œæ¯”å¦‚è¯´å¾ªçŽ¯è®¿é—®ä¸€ä¸ªæ¯”å†…å­˜é¡µç¨å¤§ä¸€ç‚¹çš„æ•°ç»„ï¼ŒFIFOä¼šè®©ä½ çŸ¥é“ä»€ä¹ˆå«å†…å­˜çš„ç©ºé—´ï¼Œç£ç›˜çš„é€Ÿåº¦ã€‚

æ›´æ™ºèƒ½ä¸€äº›çš„ç­–ç•¥æ¯”å¦‚åƒLRUï¼Œå®ƒç›¸ä¿¡ç¨‹åºçš„å†…å­˜è®¿é—®å…·æœ‰å±€éƒ¨æ€§ï¼Œé€šè¿‡æŸ¥çœ‹åŽ†å²ä¿¡æ¯ä¸­å“ªäº›é¡µè¢«é¢‘ç¹è®¿é—®ä»Žè€Œå†³å®šå°†è¿™äº›é¡µä¿å­˜åœ¨å†…å­˜ä¸­ã€‚å½“ç„¶ï¼Œå®ƒä¹Ÿæœ‰å®ƒçš„é—®é¢˜ï¼Œå’Œä¹‹å‰æåˆ°çš„ä¸€æ ·ï¼Œå¾ªçŽ¯è®¿é—®ä¸€ä¸ªç¨å¤§ä¸€ç‚¹çš„æ•°ç»„ï¼Œæœ‰å±€éƒ¨æ€§ï¼Œä½†è¿™ä¸ªå±€éƒ¨æ€§ä¸å¥½åˆ©ç”¨ã€‚

---

LRUçœ‹èµ·æ¥å·²ç»æ˜¯ç›¸å½“å¥½çš„ç­–ç•¥äº†ï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå¦‚ä½•å®žçŽ°LRUï¼Œå‡†ç¡®æ¥è¯´ï¼Œæ€Žä¹ˆä¸ºè¿™äº›é¡µåšä¸ªè®°å½•æ¥è®©æˆ‘ä»¬å¯ä»¥çŸ¥é“å“ªä¸ªæ˜¯æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„é‚£ä¸ªã€‚

ä¸€ä¸ªç®€å•çš„æ–¹æ³•æ˜¯ä¸ºæ¯ä¸ªé¡µéƒ½è®¾ç½®ä¸€ä¸ªæ—¶é—´æˆ³ï¼Œéœ€è¦äº¤æ¢é¡µæ—¶æ‰¾åˆ°é‚£ä¸ªæ—¶é—´æœ€æ—©çš„é¡µã€‚è¿™ä¸ªæ–¹æ³•çš„æ—¶é—´å¤æ‚åº¦æ˜¯O(n)ï¼Œé¡µå°‘çš„æ—¶å€™å¾ˆå¥½ç”¨ï¼Œä½†å¦‚æžœé¡µå¤šçš„æ—¶å€™ï¼Œå¼€é”€å°±ä¼šå¾ˆå¤§ã€‚

ä¸ºäº†é™ä½Žå¼€é”€ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡å–è¿‘ä¼¼LRUçš„æ–¹æ³•ï¼Œä¸éœ€è¦ç²¾å‡†åœ°ç¡®ä¿æ¢å‡ºçš„é¡µæ˜¯æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ï¼Œåªè¦ä¿è¯ç›¸å¯¹è¿‘ç›¸å¯¹å°‘ä½¿ç”¨å°±å¯ä»¥ã€‚

æˆ‘ä»¬ä¸ºæ¯ä¸ªé¡µè®¾ç½®ä¸€ä¸ªä½¿ç”¨ä½ï¼Œå½“è¯¥é¡µè¢«å¼•ç”¨æ—¶ç¡¬ä»¶å°†å…¶ä½¿ç”¨ä½è®¾ä¸º1ï¼Œç­‰åˆ°ä¸‹ä¸€æ¬¡å†å¼•ç”¨è¯¥é¡µæ—¶ï¼Œæ“ä½œç³»ç»Ÿå°±ä¼šçŸ¥é“è¯¥é¡µæœ€è¿‘è¢«ä½¿ç”¨è¿‡ï¼Œå°†è¯¥é¡µä½¿ç”¨ä½ç½®0çš„åŒæ—¶è®¿é—®ä¸‹ä¸€ä¸ªé¡µï¼Œå¦‚æžœä¸‹ä¸€ä¸ªé¡µä½¿ç”¨ä½ä¸º0ï¼Œé‚£å°±å°†è¿™ä¸€é¡µäº¤æ¢ã€‚è¿™ç§ç®—æ³•ç§°ä¸ºæ—¶é’Ÿç®—æ³•ï¼Œå…¶ä¸­æŒ‡å‘é¡µçš„æŒ‡é’ˆï¼ˆå‡†ç¡®æ¥è¯´æ˜¯æŒ‡å‘é¡µè¡¨é¡¹çš„ï¼Œæ¯•ç«Ÿé¡µä¸æ˜¯è¿žç»­åˆ†å¸ƒçš„ï¼‰ç§°ä¸ºæ—¶é’ŸæŒ‡é’ˆã€‚

æ—¶é’Ÿç®—æ³•æœ‰ä¸€ä¸ªå°ä¿®æ”¹ï¼Œè€ƒè™‘åˆ°å¦‚æžœä¸€ä¸ªå†…å­˜é¡µè¢«å†™å…¥æŸäº›å†…å®¹çš„è¯ï¼Œé‚£è¦å°†å®ƒæ¢å‡ºæ—¶å°±éœ€è¦æŠŠæ–°å†…å®¹å†™å…¥ç£ç›˜ï¼Œè¿™æ ·çš„é¡µç§°ä¸ºè„é¡µã€‚æ¢è„é¡µçš„å¼€é”€å¾ˆå¤§ï¼Œæˆ‘ä»¬å¸Œæœ›æ¢ä¸€äº›æ²¡è¢«å†™è¿‡çš„é¡µï¼Œè¿™æ ·åªéœ€è¦åœ¨å†…å­˜çš„é¡µè¡¨é¡¹ä¿®æ”¹ä¸€äº›å­˜åœ¨ä½å°±å¯ä»¥äº†ã€‚å› æ­¤æˆ‘ä»¬ä¸ºæ¯ä¸ªé¡µåˆè®¾ç½®äº†ä¸€ä¸ªè„ä½ï¼ˆä¿®æ”¹ä½ï¼‰ï¼Œå¹¶åœ¨è€ƒè™‘æ¢å‡ºé¡µæ—¶åªæ¢é‚£äº›ä½¿ç”¨ä½å’Œä¿®æ”¹ä½éƒ½ä¸º0çš„é¡µï¼Œå½“ç„¶æžç«¯æƒ…å†µä¸‹é¦–å…ˆè¦è€ƒè™‘ä½¿ç”¨ä½ä¸º0çš„é¡µã€‚

æœ€åŽæˆ‘ä»¬å†è€ƒè™‘ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼Œå¦‚æžœè¿›ç¨‹æ€»æ˜¯ç”³è¯·è¶…å‡ºå†…å­˜å®¹é‡çš„å­˜å‚¨æ€Žä¹ˆåŠžï¼Ÿåœ¨æ¡ä»¶å…è®¸çš„æƒ…å†µä¸‹ï¼Œç³»ç»Ÿä¼šè¿›è¡Œä¸æ–­åœ°æ¢é¡µï¼Œå°±åƒFIFOé‡åˆ°å¤§ä¸€ç‚¹çš„æ•°ç»„é‚£æ ·ï¼Œè¿™ç§æƒ…å†µè¢«ç§°ä¸ºæŠ–åŠ¨ã€‚ä¸€äº›æ—©æœŸæ“ä½œç³»ç»Ÿæ£€æµ‹åˆ°æŠ–åŠ¨åŽå¯èƒ½ä¼šé€‰æ‹©æ”¾å¼ƒä¸€äº›ä¸å¸¸ç”¨è¿›ç¨‹çš„è¿è¡Œï¼Œä»Žè€Œå¤„ç†è¿™ç§å†…å­˜è¶…è½½æƒ…å†µï¼ŒæŸäº›ç‰ˆæœ¬çš„Linuxæ“ä½œç³»ç»Ÿä¼šé€‰æ‹©ç›´æŽ¥æ€æ­»å†…å­˜å¯†é›†åž‹è¿›ç¨‹ï¼Œå½“ç„¶è¿™ä¸ªæ“ä½œä¼šæ¯”è¾ƒå±é™©ã€‚

é¡µæ›¿æ¢çš„ç­–ç•¥æ˜¯å¦‚æ­¤å¤æ‚ï¼Œå¦‚æžœä½ å®žåœ¨ä¸æƒ³äº†è§£è¿™ä¹ˆå¤æ‚çš„ä¸œè¥¿ï¼Œè¿™é‡Œå¯ä»¥ä¸ºä½ æä¾›ä¸€ä¸ªæ›´åŠ æœ‰æ•ˆçŽ‡ï¼Œæ›´åŠ ç®€å•ï¼Œæ›´åŠ å¼ºå¤§çš„æ–¹æ³•â€”â€”ä¹°æ›´å¤šçš„å†…å­˜ï¼ŒæŠŠè¶…è¶Šç‰©ç†å†…å­˜çš„å‡è±¡å˜æˆçœŸçš„ï¼Œå°±è¿™ä¹ˆç®€å•ã€‚



#### VAX/VMS è™šæ‹Ÿå†…å­˜ç³»ç»Ÿ

è¿™æ˜¯ä¸€ä¸ªçœŸå®žçš„æ“ä½œç³»ç»Ÿï¼Œä½†åœ¨è¿™é‡Œæˆ‘ä»¬åªä»‹ç»å…³äºŽå®ƒçš„å†…å­˜ç®¡ç†æ–¹é¢çš„ä¸€éƒ¨åˆ†å†…å®¹ï¼Œç”¨äºŽå¯¹å‰é¢å†…å®¹çš„è¡¥å……ï¼Œæ›´å¤šè¯¦ç»†å†…å®¹è¯·å‚è€ƒã€ŠOSTEPã€‹ã€‚


##### æŒ‰éœ€ç½®é›¶

å½“ä½ ç”³è¯·ä¸€ä¸ªæ–°ç©ºé—´æ”¾åœ¨è¿›ç¨‹çš„å †ä¸Šæ—¶ï¼Œä¸€èˆ¬è¦å°†è¿™ä¸ªé¡µçš„å†…å®¹å…¨éƒ¨ç½®é›¶ï¼Œè¿™æ˜¯ä¸ºäº†ä¿è¯è¿™ä¸ªé¡µåŽŸæ¥çš„å†…å®¹ä¸è¢«è¯¥è¿›ç¨‹çœ‹åˆ°ã€‚

è¿™æ ·åšçš„å¼€é”€ä¼šå¾ˆå¤§ï¼Œè€Œä¸”ä½ ä¹Ÿä¸ä¸€å®šä½¿ç”¨è¿™ä¸ªé¡µã€‚æŒ‰éœ€ç½®é›¶è¦æ±‚æ“ä½œç³»ç»Ÿåœ¨å¢žåŠ é¡µæ—¶ä¸ç”¨å°†é¡µç½®é›¶ï¼Œè€Œæ˜¯è®¾ç½®ä¿æŠ¤ä½ï¼Œå°†è¯¥é¡µè®¾ç½®ä¸ºå¯¹è¿›ç¨‹ä¸å¯è®¿é—®ï¼Œç›´åˆ°è¿›ç¨‹éœ€è¦å†™å…¥å†…å®¹æ—¶æ‰ä¼šé™·å…¥æ“ä½œç³»ç»Ÿè¿›è¡Œç½®é›¶å’Œæ›´æ”¹æƒé™ã€‚

åœ¨å¤šçº§ç¼“å­˜ä¸­ï¼Œå¾ˆå¤šä¸´æ—¶å†…å®¹å¯ä»¥ç›´æŽ¥é€šè¿‡ç¼“å­˜ä½¿ç”¨ï¼Œä¸éœ€è¦å†™å…¥å†…å­˜ï¼ŒæŒ‰éœ€ç½®é›¶å¾ˆå¥½åœ°ä¿è¯äº†è¿™äº›æ“ä½œä¸ä¼šå¸¦æ¥å¤ªå¤§çš„å¼€é”€ã€‚

##### å†™æ—¶å¤åˆ¶

ä¸åŒçš„è¿›ç¨‹å¯èƒ½ä¼šå…±ç”¨åˆ°åŒä¸€æ®µä»£ç æˆ–è€…æ•°æ®ï¼Œä¸ºäº†æé«˜å†…å­˜æ•ˆçŽ‡æˆ‘ä»¬ä¼šæŠŠè¿™äº›ä»£ç æ®µè®¾ç½®ä¸ºå…±äº«ï¼Œå¹¶æ·»åŠ åˆ°ä¸åŒè¿›ç¨‹çš„é¡µè¡¨ä¸­åŽ»ï¼Œæ¯”å¦‚ä¸‹é¢çš„æ“ä½œç³»ç»Ÿä»£ç æ˜ å°„åˆ°ä¸åŒè¿›ç¨‹é¡µè¡¨ä¸­ï¼š

![åœ°å€ç©ºé—´](img3/VMSåœ°å€ç©ºé—´.png)

è¿™ä¹ˆåšå¯ä»¥é¿å…éœ€è¦æ“ä½œç³»ç»Ÿæ—¶è¿˜è¦åšæ­£å¸¸è¿›ç¨‹åˆ‡æ¢çš„ä¸€å¤§å †å·¥ä½œï¼Œå°±åƒç›´æŽ¥è°ƒç”¨ç”¨æˆ·ç¨‹åºçš„ä¸‹ä¸€æ¡æŒ‡ä»¤ä¸€æ ·ï¼Œç®€å•è€Œå¿«æ·ã€‚å½“ç„¶ï¼Œå¿…é¡»æ³¨æ„ä¿æŠ¤ç³»ç»Ÿç©ºé—´ï¼Œä¸èƒ½è®©ç”¨æˆ·ç¨‹åºéšæ„è®¿é—®å’Œä¿®æ”¹ç³»ç»Ÿç©ºé—´çš„å†…å®¹ï¼Œå› æ­¤åŠ ä¸€äº›ä¿æŠ¤ä½è®¾ç½®æƒé™æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚

å½“ç„¶æœ‰çš„å…±äº«ä»£ç å…è®¸å†™å…¥ï¼Œå½“è¿›ç¨‹éœ€è¦å†™å…¥æ—¶ï¼Œä¸ºè¯¥è¿›ç¨‹å¤åˆ¶ä¸€ä¸ªæ–°çš„å‰¯æœ¬ï¼Œè€ŒåŽŸæ¥çš„ä¾ç„¶ä¾›ç»™å…¶å®ƒç¨‹åºè¿›è¡Œåªè¯»æ“ä½œã€‚

ç›¸æ¯”äºŽæ¯æ¬¡æœ‰è¿›ç¨‹å¼•ç”¨æ—¶éƒ½å¤åˆ¶ä¸€ä¸ªæ–°å‰¯æœ¬ï¼Œå†™æ—¶å¤åˆ¶å¤§å¤§èŠ‚çœäº†å¼€é”€å’Œå†…å­˜ç©ºé—´ã€‚

### ç»“æŸ

åœ¨å®žçŽ°äº†CPUè™šæ‹ŸåŒ–å’Œå­˜å‚¨è™šæ‹ŸåŒ–ä¹‹åŽï¼Œæ‰€æœ‰çš„è¿›ç¨‹éƒ½å¾ˆé«˜å…´äºŽè‡ªå·±èŽ·å¾—äº†ä¸“æœ‰çš„CPUå’Œå­˜å‚¨ï¼Œè™½ç„¶å¤§å®¶åœ¨åŒä¸€å°æœºå™¨ä¸Šå·¥ä½œï¼Œä½†å°±çŽ¯å¢ƒè€Œè¨€ç®€ç›´æ˜¯è‡ªå·±ç‹¬ç«‹æ‹¥æœ‰ä¸€å°æœºå™¨ä¸€æ ·ï¼å½“ç„¶ï¼Œæ“ä½œç³»ç»Ÿå’Œç¡¬ä»¶çŸ¥é“è¿™äº›åªæ˜¯å‡è±¡ï¼Œä¸è¿‡ä¸ºäº†æ›´å¥½åœ°è®©è¿›ç¨‹ä»¬æ–¹ä¾¿å·¥ä½œï¼Œå®ƒä»¬ä¼šå¤„ç†å¥½ä¸€åˆ‡ï¼Œä»¥ç»´æŠ¤è¿™ä¸ªå‡è±¡ã€‚
