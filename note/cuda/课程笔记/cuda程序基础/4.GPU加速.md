## 获得GPU加速的关键

### 使用CUDA计时方式

CUDA给出了一种针对CUDA事件的计时方式，如下所示：

```cpp
cudaEvent_t start, stop;
CHECK(cudaEventCreate(&start));
CHECK(cudaEventCreate(&stop));
CHECK(cudaEventRecord(start));
cudaEventQuery(start);

// 需要计时的代码块

CHECK(cudaEventRecord(stop));
CHECK(cudaEventSynchronize(stop));
float elapsed_time;
CHECK(cudaEventElapsedTime(&elapsed_time, start, stop));
printf("Time = %g ms.\n", elapsed_time);

CHECK(cudaEventDestroy(start));
CHECK(cudaEventDestroy(stop));
```

> 用条件编译的方式选择程序中所用浮点数的精度，放在程序的开头部分：
>
> ```cpp
> #ifdef USE_DP
>   typedef double real;
>   const real EPSILON = 1.0e-15;
> #else
>   typedef float real;
>   const real EPSILON = 1.0e-6f;
> #endif
> ```
> 可以在程序的开头加 `#define USE_DP` 选择双精度浮点，不加的话代表单精度。也可以通过编译选项定义。

### CPU的计时方式

这段代码计算了核函数开始和结束之间的时钟周期数
```cpp
#include <time.h> 
    ……
    time_t start = clock();
    vectorAdd<<<1, 1>>>(da, db, dc, N);
    cudaDeviceSynchronize();
    printf(“GPU Time:%lu: \n”, clock() - start);
    ……
```

这段代码输出了打印hello world消耗的时间
```cpp
#include <stdio.h>
#include <time.h> 

void __global__ hello_from_gpu() {
    // 注意：CUDA 内核中的 printf 在某些情况下可能不会立即执行
    printf("Hello World from GPU!\n");
}

int main() {
    clock_t start = clock();
    hello_from_gpu<<<2, 4>>>();  // 8个线程
    cudaDeviceSynchronize();
    clock_t end = clock();

    // 将时钟周期转换为纳秒
    long long elapsed = (long long)(end - start) * 1000000000LL / CLOCKS_PER_SEC;
    printf("GPU Time: %lld ns\n", elapsed);
    return 0;
}

```

### 对GPU进行性能测试

使用Nsight System来查看核函数的性能，使用管理员权限在命令行输入：
```bash
K:
cd "K:\codes\test\cuda\CudaRuntime1\CudaRuntime1\x64\Debug"

nsys profile --stats=true ./CudaRuntime1.exe
```

执行后生成两个文件，分别是`report1.nsys-rep`和`report1.sqlite`。然后输出分析结果在命令行。


### 报错处理

```bash
[6/8] Executing 'cuda_gpu_kern_sum' stats report
[libprotobuf ERROR C:\dvs\p4\build\sw\devtools\Agora\Rel\QuadD_Main\Imports\Source\ProtoBuf\protobuf-3_21_1\src\google\protobuf\wire_format_lite.cc:618] String field 'Agent.StatsReportExecutionInfo.output' contains invalid UTF-8 data when parsing a protocol buffer. Use the 'bytes' type if you intend to send raw bytes.
[7/8] Executing 'cuda_gpu_mem_time_sum' stats report
```

这个错误提示表明，在处理 `Agent.StatsReportExecutionInfo.output` 字段时，`Protobuf` 期望一个有效的 UTF-8 编码字符串，但是该字段的内容包含了无效的 UTF-8 数据。

将 `Agent.StatsReportExecutionInfo.output` 字段的类型从 string 改为 bytes。这样，Protobuf 就能够正确地处理原始字节数据，而不要求它是有效的 UTF-8 字符串。

例如，原本的字段定义可能是：

```protobuf
message StatsReportExecutionInfo {
    string output = 1;
}
```

应该改成：

```protobuf
message StatsReportExecutionInfo {
    bytes output = 1;
}
```

